---
title: 端口连通性测试
date: 2020-04-02 20:57:20
tags:
  - 运维
categories:
  - 环境
---

此文送给刚开始折腾服务器的小伙伴

有时候，端口无法访问，可能出现的问题很多。

排查要按照章法来，这是我自己总结的流程，不是太完全但大概够用，有些环境没有那么多环节，自行过滤。

- 检测端口监听
- 保证端口在最近的点(localhost)可用
- 检查防火墙、SELinux
- 检查安全组（云服务器）
- 检查服务端交换机转发、出入规则（一般人用不到）
- 检测本地段是否禁止出流量（受限制的网络环境）
- 检查一下自己脑子是不是坏了

如果某一行你完全不懂又在这说我讲得太难，那直接选择最后一行，考虑考虑是否需要退出这个行业。

## 检测端口监听

首先要保证端口开启，最简单的方法就是使用 netstat, ss 这两个工具。ss 限于 linux，参数用法自行查找
根据系统不同，命令参数和用法都有不同，这里列举几个常用的命令供大家复制。

windows:
```
直接打印出所有端口情况，-o 打印出使用端口的 PID。如何使用 PID 自行百度
netstat -ano

指定查 8080 端口情况
netstat -ano | findstr 8080

查询所有 TCP/UDP 端口情况
netstat -ano -p tcp/udp
```

Linux:
```
直接打印出所有端口情况，-p 打印出使用端口的 PID
netstat -anp

指定查 8080 端口情况
netstat -anp | grep 8080

仅查看 tcp 端口监听情况(注意是监听)，udp 把 t 换成 u
netstat -nltp
```

使用该工具可以查看到端口状态，其中，LocalAddress 列可以看到监听是在哪一个网段

这时候关注的端口如果是 LISTEN 状态，并且监听的网段是自己需要的网段，就没有问题(不懂的话去查查 ipv4 如何划分网段的，以及子网掩码怎么用)

tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      851/sshd

一般人会见到的情况有两种(如果你用docker或者其他容器技术，另讲)，拿 sshd 为例，0.0.0.0:22 或者 127.0.0.1:22，前者任何网卡都通，后者只能在回环地址上用(也就是本机)


## 如何测试端口是否可达

确保端口监听后，就要在不同的点测试端口是否可用。若不可用，先检查端口是否可达，再检查端口业务是否正常

如果端口在最远端不可达，就先去最近端检查可用性，确保端口和业务是真的可用。

tcp端口可达很容易测，只需要使用这个十分常用的工具 telnet 即可，这个工具目前不是系统自带，需要安装一下，具体过程自行查询

telnet 基于 socket(写IO的人都知道)，典型的应用是可以检测 ssh 端口和 http 端口是否可用，这对于排查防火墙、安全组等问题很有用处。

```
telnet [ip] [port]
```

但是 udp 端口很难检测，telnet 可以做 tcp 握手，但是 udp 无法实现。

实际上也有一个工具，虽然不是做这个功能的，但是可以实现排查 udp 端口是否可达，这个工具就是 nc(ncat)

不过这个排查思路不同于 tcp，只能检测端口是否可达，无法检测业务是否正常

nc 是个网络工具，可以绑定某个端口用来接收，另一端同样用 nc 发包，这工具可以检测某个 udp 端口被防火墙丢弃或者被中间路由封锁。

如下命令可构成一个 udp 发送通道

```
服务端：
nc -u -l -p 4000

客户端
nc -u 10.0.0.2 4000
```

比如 4000/udp 是 QQ 需要的端口，检测网络环境是否封禁 4000/udp 就可以在服务器上开监听端，自己电脑使用客户端

这个工具也可以检测 tcp 连通性，把 -u 去掉即可

## 剩下的排查思路

这篇文章就是个入门教程，工具用什么都好，关键是思路。

网不通先要考虑机器是否可达，可达的情况下就要一步步排查中间环节是否连通

至于业务怎么检测可用，那应该问端口业务

## 不好归类的东西

有一些可能用到的其他工具，怎么用自行搜索吧


抓包工具
tcpdump

tcpdump -nl -A port 1883


常用的网络检测工具
mtr

等同于同时使用 ping, tracert, nslookup
