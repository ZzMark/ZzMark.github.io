---
title: 用 wifi 模块配合继电器远程开机
date: 2020-04-02 20:45:20
tags:
  - Iot
categories:
  - Iot
thumbnail: /2020/04/remote-relay/1-3.jpg
---

为了给主板做远程开关机，搞了这么一个玩具

实际上想要实现该目的，有以下几个方案
  - **Wake On Lan(WOL)** 技术成本最低，但技嘉的主板想打开这个需要关闭快速启动以及一大堆的东西，很反感。
  - 论实施成本，找个远程控制的智能插座，配合主板的掉电处理，也能实现目的，只不过自己用电脑想开机，也得通过这个，体验很差

最近比较闲，买了几个 wifi 模块，配了个继电器，搞起了这么个玩具

先声明，我不是专业玩单片机、嵌入式、物联网设备的，下文可能有许多不专业的地方，虚心请教，望好心人指出。

## 物料清单

 - esp-01s(esp8266)，淘宝10块包邮
 - esp-01s 继电器模块，淘宝10块包邮
 - ttl 刷机工具，淘宝5块包邮

图中是esp-01s 继电器模块，不要在意那两个裸漏的线
{% asset_img 1-1.jpg 1-1 %}

## 玩法

esp8266 这个模块，十分的便宜，脚位齐全、搭配 ch340 串口芯片的开发板也只不过14块包邮，简化引脚的 esp-01s 更是 8 块都不到

80/160Mhz主频，80k ram，1Mbyte 或 4Mbyte rom，乐鑫官方甚至提供了 FreeRTOS 操作系统固件，虽然我不会用

生态十分齐全，当作玩具来玩的话，有 c、python([MicroPython](http://docs.micropython.org/en/latest/esp8266/quickref.html))、javaScript([Espruino](https://www.espruino.com/EspruinoESP8266))、Lua([NodeMCU](https://nodemcu.readthedocs.io/en/master/)) 语言可选，资料很全

远程控制方案，我选择了mqtt下发消息，模块改写引脚电平，触发继电器

就这么点功能，用什么语言写也就十几行的样子，不过最后我选择了 Espruino，随便写了一下，算是实现了功能

选用一些实时操作系统，比如 FreeRTOS、RIOT，都要用 linux 系统，交叉编译之类的，手上的 linux 都是服务器版，这点需求懒得折腾

## 零碎的点

- esp8266 均采用 3.3v 供电，刷写固件时官方要求电流为200ma，一般的 ttl 模块供电都足够，不过我用了辣鸡的 usb2.0 hub，供电不足，刷写成功但过不了开机的 checksum，刷了几次，概率性失效，最终换到了主机上的usb孔，解决问题

- 连接wifi，最简单的方法就是直接输入 SSID 和 password，但是 SSID 如果涉及非 ASCII 内容，需要按UTF-8输入，否则连不上。

- wifi 天线增益很小(esp-01s是印刷天线，估计是2db的)，太远了 mqtt 就会各种断线，虽然 mqtt 会重连

- esp8266 的 ttl 启动时会有启动 log，可以看到一些硬件相关的初始化信息，但波特率在 74880，直接用 115200 会表现为一堆乱码
  启动成功后，官方固件可以使用 AT 命令测试一下是否可用，发送 AT 应该会返回 `OK`，查看当前固件信息的命令为 `AT+GMR`

- ESP-01s 的 GPIO2 是绑定了指示灯的，也就是改动 GPIO2 引脚

- 如果用 C 语言，是支持 OTA 的，其他几个语言的环境似乎没有这个功能，Espruino 的代码是通过 ttl 写入的，类似于浏览器，并不需要烧录即可变更代码，并且提供了 ttl 封装重定向的相关内容。

- Espruino，执行代码很像终端(实际上就是个终端)，IDE 的原理是把代码执行一遍，执行过后需要自己写保存动作，否则重启就会重新初始化。不过 wifi 相关的信息，是写在硬件中的，调用 save(); 之后就不会丢失。

  所以代码可以遵循一个模板
  ```js
  function init() {
    // some code
  }

  E.on('init', function () {
    init();
  });
  save();
  ```

- Espruino 的 telnet，如果使用 XShell，有时候就会出现类似下图的 EOF 异常，这个可能是 telnet 实现不完全或者客户端混入了奇怪的字符，输入前先按一下 Ctrl + C，就没事了
  不过使用 windows 自带的 telnet，会有回显，很是别扭，或许可以用命令关掉回显。

## 过程和成果

起初购买继电器和模块时，贪便宜翻车了。

淘宝上能找到的版本有两种，v1.0，v4.0，两者引脚定义应该是一致的，最开始买到了 v1.0，但这个版本默认给 GPIO0 下拉，通电进入下载模式，测试 GPIO0 插槽到 GND 有1.24v 电压，认定翻车了。

IO接线什么的，随便搜一下就有，如下图
{% asset_img 1-2.jpg 1-2 %}

最终成品大概是这样，ttl 供电测试，不要在意
{% asset_img 1-3.jpg 1-3 %}

---

软件部分，选用 mqtt 下发命令，触发代码更改引脚状态。

ESP-01s 的引脚很少，GPIO0, GPIO2, RX, TX，淘宝的模块都是 GPIO0 触发

所以，整个的折腾流程就是这样：

  - ttl 刷写 Espruino 固件
  - 搭建 mqtt 服务端，我选用了 EMQX，十分专一的 mqtt 服务器，曾经在线上用过的技术，比较熟悉
  - 引入 tinyMQTT 代码库，编写业务代码
  - GPIO0 和 GPIO2 同步操作，这样可以通过板子上的灯观察结果
  - 装板，测试继电器通断

先来个 Hello world
{% asset_img 1-4.jpg 1-4 %}

然后写入代码，存进去。

最终运行状态

{% asset_img 1-6.jpg 1-6 %}

{% asset_img 1-5.jpg 1-5 %}

## Bug

因为模块的因素，通电时会有一次的继电器闭合，所以给电就会触发一次，目前还不晓得怎么处理

