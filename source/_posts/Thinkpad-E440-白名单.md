---
title: Thinkpad E440 白名单
date: 2021-01-12 15:41:23
updated:
tags:
categories:
cover: /gallery/Thinkpad-E440-白名单.png
thumbnail: /gallery/Thinkpad-E440-白名单.png
---

本文就是与白名单斗争的血泪史

白名单一共有两种对抗手段
1. 修改逻辑，废除白名单校验功能，直白的讲，就是有个判断，不让代码执行就ok了
2. 修改数据库，让自己要换的卡成为bios支持的卡。原本支持三块无线网卡，把其中一个的id替换成新卡的id就行

我最终使用了第二种 `修改数据库` 的方案，就是替换已有的硬件id

目前，网上修改白名单的教程，都太老啦，现在工具链比以前先进了很多(感谢vit9696大神的[LongSoft/UEFITool](https://github.com/LongSoft/UEFITool))

所以我这里用了新的手段，更简单了

1. 读取bios
2. 用 UEFITool 找到目标模块，配合 二进制编辑器(我用的 HxD) 替换某块已存在的网卡
3. 烧录回去

但是，因为intel的安全限制，更新bios是有校验的，笔记本无法随便刷 bios，也就是你改完了bios，却没法用原本的软件刷入

所以，想要修改 bios，需要直接用编程器去烧录 bios 芯片
![淘宝随便搜的，第三个烂大街的，是山寨货，能用但坑不浅，后面会说](2.png)

以下就是翻车全过程

- e440 的 bios 分为两个芯片存放，64MBit的 Bios，32MBit的 EC
- 我有编程器，但是个山寨货，满淘宝都是同款山寨，毕竟就只是个SPI串口烧录，没有核心技术。开源的板都抄不明白必须得告别这个行业了。
- 山寨烧录器配的烧录软件，也是破解版本，最大的坑点，也是翻大车的理由
- 官网的 bios 文件，是 12Mbyte(注意单位，1Mbyte = 8MBit)，我没有分离手段，也就是我只能靠备份来拿原始 bios

我不太想拆 bios，考虑过 SOP 夹子，但这东西，用过的都知道，十几块的玩意就跟一次性一样，而这个笔记本有俩芯片，

所以我最终选择了这个东西
![没有考虑尺寸](3.png)

但是买的时候，忘记考虑尺寸，到手发现，根本夹不上去，最后还是上烙铁焊下来

![准备把EC装回去时的照片](4.jpg)


## 读取

> 买编程器的时候，都会有配套的软件，鉴于很多人购买的 CH341A 编程器是山寨产品、软件均是破解来的盗版（正版：skygz.taobao.com）
  破解来的软件非常不好用（芯片支持不够、报错闪退等）
  所以，强烈建议大家丢弃那个破软件
  ![网上借来的图](5.png)
  满网都是盗版，各种投毒，支持芯片少之又少。
  推荐使用 AsProgrammer，有 dalao的汉化，还有简单的说明：[介绍一款 CH341A 编程/烧录 软件 AsProgrammer 汉化版](http://www.smxdiy.com/thread-1195-1-1.html)

读取的过程，没啥的。

我的主板，bios和ec是分成两个芯片的，型号分别为 `winbond 25q64fvsig` 和 `winbond 25q32fvsig`，之前已经提到，32MBit的是EC，64MBit的是bios(我怎么知道的？没什么神奇的，翻资料)

thinkpad 的白名单功能，在EC中，所以需要读取的是 32MBit 的那个。

软件那边，能识别出芯片，就是没问题，具体的芯片型号可以直接看芯片的丝印

> 若识别错误，可能是接触不良，去排查线路。

读取过程，一定要多读取几次，不要怕耽误时间。

- 多次读取后，把每一次的都丢进 `文件 crc32` 算一下是否一致

- 这个可以随便找在线工具，比如这个 [文件校验](http://tools.jareye.com/crypto/fileverify.html)

最好是读取三次，都一致就ok，若有不一致的，再读几次，确保大部分都是一致的，那个版本基本不会是损坏的



## 修改

网上各种教程会让你使用 PhoenixTool 解包，用xsearch搜索，再修改，然后用工具打包。这一堆操作很容易出问题，所以我用更加便捷的工具来做这个。感谢vit9696

所需工具，一共两个，

* [LongSoft/UEFITool](https://github.com/LongSoft/UEFITool)
* HxD 或者 winhex

下载 UEFITool 时，注意版本，带NE的版本只有查看和提取能力，不能替换。我们需要不带NE的完全版本，替换模块

![单独打开EC肯定会有警告，无视就好](6.png)


首先掌握一个基本技能，就是转换硬件id

```
// 参考网卡，rtl8723be 到设备管理器中寻找。没有留图
PCI\VEN_10EC&DEV_B723&SUBSYS_B72817AA&REV_00

// 提取每一部分，然后丢弃 REV (似乎这个不能丢弃，硬件id中有 REV01可能需要保留，但大部分都没有，起码我这个没有)
10EC B723 B72817AA 00

// 反写
EC10 23B7 AA1728B7

// 去掉空格，这就是最终结果，ec中存放的数据都是这个
EC1023B7AA1728B7
```

1. 定位要提取的模块
  白名单中肯定包含当前的卡
  搜索 Hex Pattern: header and body:  `EC1023B7AA1728B7`
  ![header and body](7.png)
  当然，搜索 Text : `Unauthorized network card is plugged` 记得区分大小写，这句话来源于触发白名单时，屏幕上的提示

2. 提取模块
  双击搜索结果，就能定位到我们要找的地方。
  ![LenovoWmaPolicyDxe](9.png)
  右键 `Extract body` 提取出这个部分即可
  如果点击下面那一行的 User interface，可以在右侧看到 `Text: LenovoWmaPolicyDxe`，就是这个模块的名字

## 修改白名单

这里采用了替换法，找一个替死鬼换掉即可

用二进制编辑工具，打开提取出的模块

搜索 `EC1023B7AA1728B7`，能看到三个网卡的硬件id
![三个硬件id](10.png)

选择其中一个做替死鬼，将新网卡的id写入即可

保存，然后使用 UEFITool 替换刚刚提取的那个模块

`右键-Replace Body`

然后保存，保存的结果就是修改好的 EC

![杂乱的笔记](20.jpg)

## 烧录回去

将修改好的EC，刷回去，就行了

## 翻车记录

我翻车的理由，要怪那个山寨的破解软件，不支持我的芯片，我还没有注意到

结果我修改了一个损坏的 EC，刷回去时也是损坏的。

最终，只能淘宝买一份原始 Bios，重新修改，两个都拆下来，两个都刷到原始版本，最终解决了问题

痛恨这傻逼的软件

## 另一种尝试

其实，我还做了另一种尝试，虽然只走到了一半。

这个尝试极其复杂，外行止步

首先，额外需要的软件有
- IDA Pro 用于反汇编，若要更好的分析流程，最好找个破解版，带 decompiler 反编译器的

其次，需要一个常识
- 这种涉及到偏移量的汇编，不要妄图增加一个赋值操作，或者删除某些代码，那需要重编译，否则容易导致破坏原有的执行，反而出现bug

思路就是，找到关键代码，桥接掉

顺着 `Unauthorized network card is plugged` 开始查找，可以找到以下函数 `sub_690`

![目标方法](11.jpg)

这段代码决定了打印错误内容

通过 IDA 找到哪里调用了这个函数
![目标方法](12.jpg)

图中的 `while(1) ;`，就是祸首

找到对应的汇编

![目标方法](13.jpg)

然后，就是如何跳转到正确的位置

需要修改的时 
```
loc_826:
...
call  sub_690 // 从这里开始，让代码跳转到下边的 loc_845
```

可惜，我专业能力不足，不晓得怎么跳转……

毕竟我一点汇编都没学过……


## 附录

资源下载

- [介绍一款 CH341A 编程/烧录 软件 AsProgrammer 汉化版](http://www.smxdiy.com/thread-1195-1-1.html)
- [LongSoft/UEFITool](https://github.com/LongSoft/UEFITool)
- Hxd
- e440 (型号: 20c5 ver: 2.22 board: nw-151a) 工厂 Bios

其余的稍后补充
