---
title: arthas使用记录
date: 2018-12-24 00:00:00
tags: 
 - JVM
 - Java
categories:
 - 后端
---

前些日子遇到了一次线上问题，新部署的机器，还没有流量，浏览器页面第一次打开耗时极其过分(10s~40s)，机器没崩人先疯了。

几个命令下去，机器内存、cpu、IO 负载等参数表示机器很闲，所以怀疑是代码问题

浏览器 devTools 上显示请求耗时都在 `TTFB` 上

当时看着代码怀疑了一圈又一圈，尝试在本地 debug 复现，折腾了两个小时，复现失败。

然后尝试找某种监测方法调用的工具，搜到了几个不同种类的工具，btrace、jvm-sandbox、arthas、greys，这几个工具都十分的强大，不过最终我选用了arthas，当然理由很肤浅只是因为中文手册容易阅读（救场如救火）

## 思路

实际上这篇文章，只是为了记录下排错的思路，具体的操作当时没有记录下来

这个工具能实现排查链路中每个调用的耗时情况，当然并没有递归(可能别的工具有)，所以只能定位过滤到的方法内的调用。

不过基于这点，就可以解决许多的问题了

好了，本文完结，下面的是我事后整理的过程。

> 计算方法调用的耗时和链路上的耗时，使用trace命令加#cost筛选时间，这个命令可以打印出调用列表和每个方法调用的耗时
    定位到某个耗时很大的方法上，大概就达成80%了，毕竟这种原因不明的问题，找到问题比解决问题更难
    实际上我这次使用已经结束了，我监测的是入口，直接定位到了耗时极大的getSession()方法，然后怀疑是tomcat生成sessionId的时候调用的Random性能不足，替换为 /dev/./urandom 问题解决
    如果你发现这条链路上耗时极大的方法可能有多个调用来源，那就使用stack来抓取调用链，可以找到调用来源
    精确定位好后，用watch抓取方法入参和出参
    大概就这些了

## 后记

文章相当短，这工具我也只摸了皮毛（救场如救火）

只能说自己无知，有这方面经验的人直接就会想到用这类工具排查，不会绕这么大个弯子。这次经验也算是给自己增加了一种排错手段

至于当时遇到的问题到底是啥？

tomcat, 云服务器部署，默认使用了 `/dev/random`，云服务器可能没有做处理，熵池亏空，导致了在生成 session 这个步骤时产生了阻塞。
最终解决方法，已经时江湖广为流传的，`-Djava.security=file:/dev/./urandom`

2019.01.04：
唯品会的白衣大大曾经还详细分析过这个问题，在这里贴上原文：[SecureRandom的江湖偏方与真实效果](http://calvin1978.blogcn.com/articles/securerandom.html)
