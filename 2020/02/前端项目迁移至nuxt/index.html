<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>前端项目迁移至 nuxt.js - 调律者</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="调律者"><meta name="msapplication-TileImage" content="/static/img/avatar.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="调律者"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="160x160" href="/static/img/avatar.jpg"><meta description="文章书写于 2019-09-06，改造是8月中旬，使用的 nuxt.js 版本为 2.8.1，后升级到2.9.0，文中可能包含两个版本的内容，区别不是太大，关于版本差距详见nuxt&amp;#x2F;nuxt.js 目前项有 SEO 的需求，而前端是纯正的 SPA 应用，国内的搜索引擎目前对这些东西都没有办法，所以考虑启用 SSR 服务端渲染方案 官方提供了三种可行方案  vue-server-renderer 服"><meta property="og:type" content="blog"><meta property="og:title" content="前端项目迁移至 nuxt.js"><meta property="og:url" content="http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/"><meta property="og:site_name" content="调律者"><meta property="og:description" content="文章书写于 2019-09-06，改造是8月中旬，使用的 nuxt.js 版本为 2.8.1，后升级到2.9.0，文中可能包含两个版本的内容，区别不是太大，关于版本差距详见nuxt&amp;#x2F;nuxt.js 目前项有 SEO 的需求，而前端是纯正的 SPA 应用，国内的搜索引擎目前对这些东西都没有办法，所以考虑启用 SSR 服务端渲染方案 官方提供了三种可行方案  vue-server-renderer 服"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/logo.jpg"><meta property="article:published_time" content="2020-02-22T13:29:29.000Z"><meta property="article:modified_time" content="2020-02-22T13:29:29.000Z"><meta property="article:author" content="Mark Zhou"><meta property="article:tag" content="前端"><meta property="article:tag" content="Vue.js"><meta property="article:tag" content="Nuxt.js"><meta property="article:tag" content="SEO"><meta property="article:tag" content="SSR"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/logo.jpg"><meta property="twitter:creator" content="@Zz_Mark06"><meta property="twitter:site" content="https://twitter.com/Zz_Mark06"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/"},"headline":"调律者","image":["http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/logo.jpg"],"datePublished":"2020-02-22T13:29:29.000Z","dateModified":"2020-02-22T13:29:29.000Z","author":{"@type":"Person","name":"Mark Zhou"},"description":"文章书写于 2019-09-06，改造是8月中旬，使用的 nuxt.js 版本为 2.8.1，后升级到2.9.0，文中可能包含两个版本的内容，区别不是太大，关于版本差距详见nuxt&#x2F;nuxt.js 目前项有 SEO 的需求，而前端是纯正的 SPA 应用，国内的搜索引擎目前对这些东西都没有办法，所以考虑启用 SSR 服务端渲染方案 官方提供了三种可行方案  vue-server-renderer 服"}</script><link rel="canonical" href="http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/"><link rel="icon" href="/static/img/avatar.jpg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.4.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?c3e99bfff793bb7f4d6646bc513afec5";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-154883003-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154883003-1")</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-5036449195935522" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="调律者" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-02-22T13:29:29.000Z" title="2020-02-22T13:29:29.000Z">2020-02-22</time>发表</span><span class="level-item"><time datetime="2020-02-22T13:29:29.000Z" title="2020-02-22T13:29:29.000Z">2020-02-22</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span><span class="level-item">35 分钟读完 (大约5285个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">前端项目迁移至 nuxt.js</h1><div class="content"><p>文章书写于 2019-09-06，改造是8月中旬，使用的 nuxt.js 版本为 2.8.1，后升级到2.9.0，文中可能包含两个版本的内容，区别不是太大，关于版本差距详见<a target="_blank" rel="noopener" href="https://github.com/nuxt/nuxt.js/releases">nuxt/nuxt.js</a></p><p>目前项有 SEO 的需求，而前端是纯正的 SPA 应用，国内的搜索引擎目前对这些东西都没有办法，所以考虑启用 SSR 服务端渲染方案</p><p>官方提供了三种可行方案</p><ul><li><a target="_blank" rel="noopener" href="https://ssr.vuejs.org/">vue-server-renderer 服务端方案</a></li><li><a target="_blank" rel="noopener" href="https://github.com/chrisvfritz/prerender-spa-plugin">prerender-spa-plugin webpack预渲染插件</a></li><li><a target="_blank" rel="noopener" href="https://nuxtjs.org/">nuxt.js</a></li></ul><p>如果页面较少并且固定，那还是推荐使用预渲染方案，不过我们有详情页面需要渲染，所以这个方案无法实现，而 vue-server-renderer 因为要搭建太多内容，我们追求快速落地，所以该方案 pass。</p><p>我们最终选用了 nuxt.js，本文记录整个迁移过程和遇到的坑</p><h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p>目前项目结构为</p><ul><li>webpack, typescript, sass</li><li>vue, vuex, vue-router</li><li>element-ui</li><li>axios</li><li>baidu-map</li></ul><p>没有 jquery，手脚架为 vue-cli3 的官方手脚架(用 vue-cli-service 启动的)。</p><p>项目中大部分数据都放进了 vuex，包括登录，vuex 的数据自动保存到 localStorage 中</p><p>注意，本文的大部分说法，都是基于 typeScript，有些说法可能在 js 环境不适用，请自行测试</p><p>还要说一句，typeScript 搞这东西，真不太好用</p><h2 id="nuxt-js"><a href="#nuxt-js" class="headerlink" title="nuxt.js"></a>nuxt.js</h2><p>看官网吧</p><p>加一些我自己的补充</p><p>nuxt 的工作模式，按照我自己的话来说就是混合渲染，只有页面在首次加载时会触发服务端渲染，前端的交互操作依然遵照 SPA 的方式。</p><p>这个逻辑必须要理解，不然会遇到各种数据不加载、undefined、页面多次渲染等等一系列问题。</p><p>对新手说的话，就是浏览器刷新、地址栏敲回车。</p><p>然后，nuxt 的 asyncData 和 fetch 两部分，可能在服务端执行可能在客户端执行，但一定只执行一次，所以 asyncData 和 fetch 必须要设计成服务端和客户端都可以执行的结构。</p><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>nuxt.js 的生命周期<br><img src="https://zh.nuxtjs.org/nuxt-schema.png" alt="img"></p><p>vue.js 的生命周期<br><img src="https://vuejs.org/images/lifecycle.png" alt="img"></p><p>其中，nuxt.js 的 Render 部分，后续会接上 vue.js 的生命周期，包含 beforeCreate 和 created，而浏览器端也会再执行 beforeCreate 和 created 两个钩子，这是服务端渲染的性质。</p><h2 id="框架搭建"><a href="#框架搭建" class="headerlink" title="框架搭建"></a>框架搭建</h2><p>不建议自行添加依赖，最好是直接官方手脚架生成，然后将现有项目迁移上去</p><p>原有项目的目录结构如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">├─public</span><br><span class="line">├─scripts</span><br><span class="line">├─src</span><br><span class="line">│  ├─api</span><br><span class="line">│  ├─assets</span><br><span class="line">│  │  ├─font</span><br><span class="line">│  │  ├─images</span><br><span class="line">│  │  └─scss</span><br><span class="line">│  ├─components</span><br><span class="line">│  ├─config</span><br><span class="line">│  ├─router</span><br><span class="line">│  ├─store</span><br><span class="line">│  │  └─module</span><br><span class="line">│  ├─types</span><br><span class="line">│  │  ├─components</span><br><span class="line">│  │  └─views</span><br><span class="line">│  ├─utils</span><br><span class="line">│  ├─views</span><br><span class="line">│  │  └─index</span><br><span class="line">│  ├─App.vue</span><br><span class="line">│  └─main.ts</span><br><span class="line">├─tslint.json</span><br><span class="line">├─tsconfig.json</span><br><span class="line">├─vue.config.js</span><br><span class="line">├─package.json</span><br></pre></td></tr></table></figure><p>因为 nuxt.js 的目录结构有规范，可以用来实现很多功能，所以基本上遵照了目录结构<br>新的目录结构为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">├─.nuxt</span><br><span class="line">├─server</span><br><span class="line">│  ├─middleware</span><br><span class="line">|  └─index.js</span><br><span class="line">├─src</span><br><span class="line">│  ├─api</span><br><span class="line">│  ├─assets</span><br><span class="line">│  │  ├─font</span><br><span class="line">│  │  ├─images</span><br><span class="line">│  │  └─scss</span><br><span class="line">│  ├─components</span><br><span class="line">│  ├─config</span><br><span class="line">│  ├─layouts</span><br><span class="line">│  ├─middleware</span><br><span class="line">│  ├─pages</span><br><span class="line">│  │  ├─index</span><br><span class="line">│  │  └─index.vue</span><br><span class="line">│  ├─plugins</span><br><span class="line">│  ├─static</span><br><span class="line">│  ├─store</span><br><span class="line">│  ├─types</span><br><span class="line">│  │  ├─components</span><br><span class="line">│  │  │  └─userCenter</span><br><span class="line">│  │  └─views</span><br><span class="line">│  └─utils</span><br><span class="line">├─tslint.json</span><br><span class="line">├─tsconfig.json</span><br><span class="line">├─vue.config.js</span><br><span class="line">├─package.json</span><br><span class="line">├─nuxt.config.js</span><br></pre></td></tr></table></figure><p>这样调整尽量符合原有结构，为了这个目录结构还需要配置几个属性</p><p>nuxt.config.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;universal&#x27;</span>,</span><br><span class="line">  srcDir: <span class="string">&#x27;src&#x27;</span>, <span class="comment">// 将源码路径指向 src，默认同 rootDir 为项目根目录</span></span><br><span class="line">  <span class="comment">// other...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nuxt.js 是自动生成路由的，所以取消了 router 目录，如果要干预可以在 nuxt.config.js 手动注入额外部分，但自动部分还是会工作；<br>如果要对路由进行影响可以增加 middleware，在路由响应时改变上下文或者改变路由目的地；<br>对于动态菜单这种需求，那种后管平台没有 SSR 的必要，建议放弃</p><p>原有项目的 views 更名为 page，因为自动生成路由，所以目录结构要按照 nuxt.js 的规则来，详见 <a href="#pages">迁移指南-pages</a></p><p>assert 和 static 都是放置静态资源的地方，区别在于 assert 通过 loader 加载，可以解析 sass 等格式，而 static 为纯静态资源</p><p>components 为组件，这部分不会受到 nuxt.js 加强，也就是没有 nuxt.js 的生命周期钩子。注意该部分打包时会全部封进 app.js，如果组件是某个页面专用，就请移动到 pages 中，不要放在这里</p><p>layouts 作为布局，所有渲染的页面都要有一个对应布局，默认的布局名称为 default.vue，就是渲染模板，这里可以一定程度代替 App.vue 和 main.ts</p><p>middleware 放置路由中间件，中间的 js 文件会自动以文件名为 name 注册进 nuxt.js，在 nuxt.config.js、layouts、pages 中可以使用中间件。<br>layouts、pages 中，使用属性 <code>middleware: &#123;&#123;name&#125;&#125;</code> 即可；<br>nuxt.config.js 中按照这个格式注入</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  router: &#123;</span><br><span class="line">    middleware: <span class="string">&#x27;stats&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>plugins 文件夹内的文件会做为定制原型链的插件。因为渲染机制问题，Vue 的实例初始化没有暴露出来，nuxt 提供的方案是使用 plugins。<br>但是有很多插件注入后会出现问题影响 nuxt 正常工作，谨慎使用</p><p>store 为 vuex 的目录，nuxt 会自动生成 vuex 树，只要将 store 文件直接放入 store 目录就行，nuxt 会根据文件名生成 modules</p><h2 id="迁移指南"><a href="#迁移指南" class="headerlink" title="迁移指南"></a>迁移指南</h2><p>迁移方案选择新搭建框架，再将业务代码迁移上去。</p><p>第一步迁移的是基础工具和接口代码。</p><p>然后迁入基础结构，首先处理 App.vue 和 main.ts</p><p>App.vue 对应到 layouts/default.vue 中，根据 nuxt.js 的结构做一些替换。概念不同，但结果一致。<br>日后还是更建议将 header、footer 分发到 layouts 中，可以更好的规划布局和统一布局</p><p>整体的代码执行顺序如下，自行对照到生命周期中：</p><p>nuxt.js =&gt; plugins =&gt; router =&gt; router-middleware =&gt; layout =&gt; asyncData/fetch =&gt; create</p><h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>store 会自动按照名字分 modules，所以要确保 store 文件的命名和以前引用的模块名一致，不然就要大片的改动代码</p><p>服务端渲染需要 state部分返回一个无参方法，这里用的 ES6 语法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">  recentContactList: [],</span><br><span class="line">  chatRecordList: []</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>根据服务端渲染的逻辑，每次服务端渲染，vuex 都会重新初始化，vuex 的初始化在服务端，时机很早(应该是nuxtServletInit就有)，也就是说没有以前的数据。针对这一点有一些解决方案，但强烈不推荐将用户端的 vuex 同步到服务端这一做法，看似很美好但同步方面坑相当多。</p><p>对于服务端没有 vuex 数据的问题，我建议针对性的处理，如用户 token、用户关键信息 可存放到 cookie 中，一些整个项目随处都要用的数据也可以存放到 cookie 中。但注意容量，cookie 的空间很宝贵</p><p>对于 vuex 的一些初始化动作，举个例子，用户信息存放在 vuex 中，业务方都是在 vuex 中获取，我们可以在 middleware 中将用户信息从 cookie 中读出，存放到 vuex 中。</p><p>目前的前端有 localStorage 来保存 vuex 数据，但是要考虑数据合并造成的冲突，因为服务端渲染会将 服务端vuex 中的数据带到客户端，客户端会使用这些数据做初始化，确切的说是 初始化 =&gt; 合并服务端vuex，如果客户端从 localStorage 做了本地化，切记在合并数据时注意不要将服务端某些关键数据覆盖掉。</p><p>对于那些过度依赖 vuex 的功能，比如列表翻页的页码存放到 vuex，我建议着手拆除这类业务对 vuex 的依赖，vuex 不是这样的工具</p><h3 id="pages"><a href="#pages" class="headerlink" title="pages"></a>pages</h3><p>pages 为页面入口文件夹</p><p>服务端渲染的改造基本都在这里</p><p>根据路由生成规则，pages/index.vue 是首页入口</p><p>layouts 中的文件代替了 App.vue。</p><p>其中 layouts/error.vue 文件比较特别，这个是错误页面，后端渲染错误、后端路由错误，都会跳转至此。</p><h4 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h4><p>nuxt 会根据放入 pages 中的 文件夹/文件 来生成路由Router</p><p>规则为：</p>//<p>若 vue 文件为 index.vue，则不会生成文件名层级</p><p>在 Nuxt.js 里面定义带参数的动态路由，需要创建对应的以下划线作为前缀的 Vue 文件 或 目录。</p><p>以下<a target="_blank" rel="noopener" href="https://zh.nuxtjs.org/guide/routing">官网样例</a>：</p><p>e.g.</p><p>假设目录结构为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pages&#x2F;</span><br><span class="line">--| about&#x2F;</span><br><span class="line">-----| index.vue</span><br><span class="line">-----| one.vue</span><br><span class="line">--| users</span><br><span class="line">-----| _id.vue</span><br><span class="line">--| _slug</span><br><span class="line">-----| comments.vue</span><br><span class="line">-----| index.vue</span><br><span class="line">--| index.vue</span><br></pre></td></tr></table></figure><p>生成的路由为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">routes: [</span><br><span class="line">  &#123;</span><br><span class="line">    name: &#39;index&#39;,</span><br><span class="line">    path: &#39;&#x2F;&#39;,</span><br><span class="line">    component: &#39;pages&#x2F;index.vue&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &#39;about&#39;,</span><br><span class="line">    path: &#39;&#x2F;about&#39;,</span><br><span class="line">    component: &#39;pages&#x2F;about&#x2F;index.vue&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &#39;about-one&#39;,</span><br><span class="line">    path: &#39;&#x2F;about&#x2F;one&#39;,</span><br><span class="line">    component: &#39;pages&#x2F;about&#x2F;one.vue&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      name: &#39;users-id&#39;,</span><br><span class="line">      path: &#39;&#x2F;users&#x2F;:id?&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;users&#x2F;_id.vue&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      name: &#39;slug&#39;,</span><br><span class="line">      path: &#39;&#x2F;:slug&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;_slug&#x2F;index.vue&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      name: &#39;slug-comments&#39;,</span><br><span class="line">      path: &#39;&#x2F;:slug&#x2F;comments&#39;,</span><br><span class="line">      component: &#39;pages&#x2F;_slug&#x2F;comments.vue&#39;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="生命周期钩子"><a href="#生命周期钩子" class="headerlink" title="生命周期钩子"></a>生命周期钩子</h4><p>nuxt 的 SSR 可以说成是混合渲染，首次加载时由服务端渲染，其余的时间点都和 SPA 一致。</p><p>为了让服务端渲染时能将数据渲染到 html 中，就需要在 render 前将数据填充到应该放置的地方(data 或者 vuex)</p><p>再强调一次，vuex 在初始化时，是空的。</p><p>整体的流程可以参照生命周期的图</p><p>asyncData 和 fetch 两个步骤可以对数据进行影响，fetch 设计的功能就是填充 vuex。<br>asyncData 还额外的有一个特点，就是该步骤的返回值会合并到该页面的 data 属性中(ts语法可能不太明显，js 语法的 data 就比较容易理解了)。</p><p>这样就可以通过 asyncData 和 fetch 控制服务端渲染时，数据的范围</p><p>注意，asyncData 早于 render，所以这时还没有 this 使用，也就是和 vue 实例挂钩的内容都用不了。虽然 context 中提供了一个叫 app 的实例，但那个是 nuxt 的实例，不是当前页面的</p><p>还要注意，asyncData 和 fetch 都有可能在客户端执行，两者在整个流程中都只会执行一次。但是 create 生命周期在两端各会执行一次，如果可能的话，可以将 created 中的代码移植到 mounted 中。若还是需要使用 created(毕竟mounted慢一步)，可以选择使用以下代码做判断</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.client) &#123;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ts 的写法与 js 不同，ts 中，asyncData 和 fetch 需要写在 @Components 中，如下所示，其中 asyncData 和 fetch 的入参 context 中包含的内容参见 <a target="_blank" rel="noopener" href="https://zh.nuxtjs.org/api/context">Context</a></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  components: &#123; Footer, QuickBar, NoData &#125;,</span><br><span class="line">  <span class="keyword">async</span> asyncData (&#123; params, store, error &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span>(params.id) &#123;</span><br><span class="line">      <span class="keyword">let</span> a = <span class="keyword">await</span> store.dispatch(<span class="string">&#x27;AModules/ACTION_A&#x27;</span>, &#123;</span><br><span class="line">        id: params.id,</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        error(&#123; <span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">&#x27;数据异常&#x27;</span> &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">fetch</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondDetails</span> <span class="keyword">extends</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="comment">// other</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="meta-标签"><a href="#meta-标签" class="headerlink" title="meta 标签"></a>meta 标签</h4><p>nuxt 内部引入了 vue-meta 插件来做 meta，除了默认的命名外，使用方法完全相同，和 vuex 一样需要返回的是一个方法。具体参见 (Vue Meta)[<a target="_blank" rel="noopener" href="https://vue-meta.nuxtjs.org/guide/metainfo.html]">https://vue-meta.nuxtjs.org/guide/metainfo.html]</a><br>以下官网样例:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123; </span><br><span class="line">  head () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      title: <span class="string">`Page 1 (<span class="subst">$&#123;<span class="built_in">this</span>.name&#125;</span>-side)`</span>,</span><br><span class="line">      meta: [</span><br><span class="line">        &#123; <span class="attr">hid</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;description&#x27;</span>, <span class="attr">content</span>: <span class="string">&quot;Page 1 description&quot;</span> &#125;</span><br><span class="line">      ],</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>head 的执行时机为 render，这时是可以使用 this 的</p><h4 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h4><p>先说一下，nuxt 是有 keep-alive 的，layout.vue 的 template 部分如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;Login v-show&#x3D;&quot;isLoginShow&quot; @close&#x3D;&quot;onLogin(false)&quot;&gt;&lt;&#x2F;Login&gt;</span><br><span class="line">    &lt;nuxt keep-alive&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br></pre></td></tr></table></figure><p>这一点不得不埋怨一下官方手册，好多东西真的是找不到，还是翻阅 changelog 和 issue 才得到的解决方案</p><h3 id="调试服务端"><a href="#调试服务端" class="headerlink" title="调试服务端"></a>调试服务端</h3><p>调试分为两部分，log 和 debug</p><p>log 可以直接在控制台看到。nuxt 2.9.0 以后新增了 ssrLog 功能，可以将服务端的 log 打印到浏览器的 console 中</p><p>debug 部分，这部分有点玄学，因为有时候代码 debugger 抓不住，我也说不太清楚</p><p>方案为，借助 node 的参数 <code>--inspect</code> 将实例的 debug 功能打开，然后使用 chrome 浏览器进行调试，本机环境只要点击 F12 就能在 Elements 选项卡左边看到 node 的图标</p><p>成功的话，在启动时就可以看到日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Debugger listening on ws:&#x2F;&#x2F;127.0.0.1:9229&#x2F;61388480-18e2-4f4d-8373-f7b9909d8011</span><br><span class="line">For help, see: https:&#x2F;&#x2F;nodejs.org&#x2F;en&#x2F;docs&#x2F;inspector</span><br></pre></td></tr></table></figure><h2 id="一些使用技巧"><a href="#一些使用技巧" class="headerlink" title="一些使用技巧"></a>一些使用技巧</h2><p><strong>js-cookie</strong></p><p>提供一个修改过的 js-cookie，可以在服务端渲染时提供相同的 api，cookie 为空时会默认读取 document</p><p><a target="_blank" rel="noopener" href="https://gist.github.com/ZzMark/d93bbcbbf3b6e763062c977c269edcbf">https://gist.github.com/ZzMark/d93bbcbbf3b6e763062c977c269edcbf</a></p><p>在 asyncData 中的用法样例如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">asyncData</span>(<span class="params">&#123;req&#125;</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> cookie</span><br><span class="line">  <span class="keyword">if</span>(process.server) &#123;</span><br><span class="line">    cookie = req.headers.cookie</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userInfo = Cookies.getJSON(<span class="string">&#x27;userInfo&#x27;</span>, cookie) || &#123;&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>按需渲染</strong></p><p>有的地方没有必要让服务端渲染，SSR 针对性的将有必要的东西放到服务端即可。不过话是这么说，实际上反而是将不必要的去掉</p><p>不需要服务端渲染的地方，用<no-ssr></no-ssr>嵌套起来。</p><p>但要注意，如果不想让某个组件加载，需要在引用组件的地方用 no-ssr，不能在组件上。</p><p>典型的场景是，某个组件需要数据，没有数据导致了服务端渲染时出现了 undefined，直接用 no-ssr 将那一块套起来是没有用的</p><p>对了，no-ssr 在 nuxt3 就会被移除，尽快迁移到<client-only></client-only>吧</p><p><strong>全局加载scss</strong></p><p>SPA 场景下，直接 import 即可，但这里不行</p><p>可以使用 module: @nuxtjs/style-resources</p><p>在 nuxt.config.js 中配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  modules: [</span><br><span class="line">    <span class="string">&#x27;@nuxtjs/style-resources&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">  styleResources: &#123;</span><br><span class="line">    scss: [<span class="string">&#x27;./src/assets/scss/common.scss&#x27;</span>, <span class="string">&#x27;./src/assets/scss/font.scss&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="打包、优化"><a href="#打包、优化" class="headerlink" title="打包、优化"></a>打包、优化</h2><p>开发环境，建议使用 nuxt 来启动，生产环境更换为 express，方便在 express 中增加一些定制信息（我们在 express 中做了压缩相关的内容，这个下面会讲）。</p><p>附上我的启动指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev&quot;: &quot;cross-env NODE_ENV&#x3D;development DEBUG&#x3D;nuxt:* node node_modules&#x2F;nuxt&#x2F;bin&#x2F;nuxt&quot;,</span><br><span class="line">&quot;debug&quot;: &quot;cross-env NODE_ENV&#x3D;development DEBUG&#x3D;nuxt:* node --inspect node_modules&#x2F;nuxt&#x2F;bin&#x2F;nuxt&quot;,</span><br><span class="line">&quot;build&quot;: &quot;nuxt build --profile&quot;,</span><br><span class="line">&quot;start&quot;: &quot;cross-env NODE_ENV&#x3D;production node server&#x2F;index.js&quot;,</span><br></pre></td></tr></table></figure><h3 id="项目精简"><a href="#项目精简" class="headerlink" title="项目精简"></a>项目精简</h3><p>这个问题，仁者见仁。</p><p>大部分会遇到的应该都是按需加载，这个要挨个去试。</p><p>build 时候可以增加参数来触发 nuxt 提供的 analyze 功能(其实就是 webpack-bundle-analyzer，用过 webpack 的人都知道)</p><p>用我的命令就是<br><code>npm run build -- -a</code></p><p>剩下的看着来吧</p><h3 id="静态压缩"><a href="#静态压缩" class="headerlink" title="静态压缩"></a>静态压缩</h3><p>目前项目短期内没有使用 CDN 的打算，所以首屏加载速度的一个大头就要靠自己了。</p><p>直接使用 nuxt 的 render.compressor 只能做到首屏的 html 压缩，其余的 js 都是动态压缩，消耗过多的资源，所以打算像 SPA 那样，部署时直接放入 .gz 和 .br 文件，节约算力。但 nuxt 并没有这方面支持，所以只得靠 express 来直接返回资源。</p><p>整个改动分为两部分。1. build 时生成静态压缩文件; 2. 让 express 返回静态压缩文件</p><p>第一部分我编写了一个 middleware，代码贴在这里。实际上逻辑很简单，就是调用了 compression-webpack-plugin 生成 gzip，brotli-webpack-plugin 生成 brotli。</p><p><code>npm install -D brotli-webpack-plugin compression-webpack-plugin</code></p><p><code>/server/compressModule.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> CompressionPlugin;</span><br><span class="line"><span class="keyword">let</span> BrotliPlugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gzip = &#123;</span><br><span class="line">  test: <span class="regexp">/\.(js|css|html|svg)$/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPlugin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!CompressionPlugin) &#123;</span><br><span class="line">    CompressionPlugin = <span class="built_in">require</span>(<span class="string">&quot;compression-webpack-plugin&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!BrotliPlugin) &#123;</span><br><span class="line">    BrotliPlugin = <span class="built_in">require</span>(<span class="string">&quot;brotli-webpack-plugin&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compressionModule</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.extendBuild(<span class="function">(<span class="params">config, &#123; isDev, isServer&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDev || isServer) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    getPlugin()</span><br><span class="line">    <span class="keyword">const</span> options = <span class="built_in">this</span>.options[<span class="string">&quot;nuxt-compress&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> gzipConfig = options ? &#123; ...gzip, ...options.gzip &#125; : gzip;</span><br><span class="line">    <span class="keyword">const</span> brotliConfig = options &amp;&amp; options.brotli ? options.brotli : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    config.plugins.push(</span><br><span class="line">      <span class="keyword">new</span> CompressionPlugin(gzipConfig),</span><br><span class="line">      <span class="keyword">new</span> BrotliPlugin(brotliConfig)</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = compressionModule;</span><br></pre></td></tr></table></figure><p>然后在 nuxt.config.js 中添加以下配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// version &lt; 2.9.0 使用 devModules 替换 buildModules</span></span><br><span class="line">  buildModules: [</span><br><span class="line">    <span class="string">&#x27;~~/server/compressModule&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二部分要让 express 读取静态压缩文件，借助了 express-static-gzip 这个中间件。这个中间件做了比较完善的处理，放心使用</p><p>在 express 入口，注册这个中间件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载 static gzip br 并优先提供 brotli 压缩</span></span><br><span class="line">app.use(<span class="string">&quot;/_nuxt/&quot;</span>, expressStaticGzip(<span class="string">&#x27;./.nuxt/dist/client&#x27;</span>, &#123;</span><br><span class="line">  enableBrotli: <span class="literal">true</span>,</span><br><span class="line">  orderPreference: [<span class="string">&#x27;br&#x27;</span>]</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>该配置基于默认情况，build 后访问的 js 路径为 <code>example.com/_nuxt/xxxxxxxxxxxxxxx.js</code></p><h3 id="css-分离"><a href="#css-分离" class="headerlink" title="css 分离"></a>css 分离</h3><p>nuxt 提供了配置，直接使用即可实现大概的效果</p><p>build.extractCSS = true</p><p>如果要精确来，就自行研究吧，反正这个是实现我们想要的样子了</p><h2 id="其他-nuxt-js-的坑"><a href="#其他-nuxt-js-的坑" class="headerlink" title="其他 nuxt.js 的坑"></a>其他 nuxt.js 的坑</h2><ul><li><p>layout 如果在<nuxt>下方有组件，会出现两次渲染的问题，这个问题我也解释不了，我是直接绕开了这个。有发生相同情况的小伙伴就去提 issue 吧</p></li><li><p>nuxt.js 选用了 axios，依赖为 <code>@nuxtjs/axios</code>，官网说不需要自行再引入 axios，但我这里不引入什么都干不了……<br>nuxt.config.js 中要加入 modules 配置，手脚架已经给出了配置<br>我们的业务会通过API封装执行 http，所以不需要进一步处理</p><p>服务端的 axios 不会自动携带 Cookie。如果想要优雅的解决，那就在 axios 封装那里新增一个接口来注入 Cookie，然后靠 router-middleware 从 context.headers.cookie 获取并注入</p></li><li><p>vuex 在服务端初始化，然后将数据递交给前端，不清楚客户端初始化时会不会再初始化插件</p></li><li><p>引入许多代码都会出现 unexpected identifier，可以在调用栈中看到是哪个 loader 加载哪个文件时发生的问题，调用栈可以看报错时的网页。<br>但并不好解决，一般时候都是因为组件注册，引入时调用了某些代码，目前的解法都是改为直接引用组件，让整条链路避开 Vue.use 和 Vue.component。</p></li><li><p>凡是动用 window 或 document 以及下设对象的代码，都要避免让服务端执行。</p></li><li><p>Vue.use() 有不少组件无法引入，解决方案为局部引入。但也有组件局部引入就无法工作，这时候可能就要全局引入。</p></li><li><p>目前有一个最坑的东西，not matching，服务端渲染结果与浏览器渲染结果不匹配。<br>开发环境会导致浏览器抛弃冲突的标签重新再渲染一次，并抛出警告；生产环境不会有处理。官方讲最常见的是 table 中的 tbody，实际场景中，服务端 render 和客户端 render 不匹配就会出现这个，比如客户端因为数据不同重新渲染的结果不一致<br>这个问题尽量避免，因为可能会出现因数据异常导致页面直接卡住(常见于 v-if 使用不当)</p></li><li><p>如果出现这个警告<br><code>WARN: Please use build.postcss in your nuxt.config.js instead of an external config file. Support for such files will be removed in Nuxt 3 as they remove all defaults set by Nuxt and can cause severe problems with features like alias resolving inside your CSS.</code></p><p>实际上是很小的事，就是告诉你 postcss 要配置到 nuxt.config.js 中了，把 postcss 的配置文件中所有内容配置到 build.postcss 中即可。</p></li></ul><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>关于这次迁移，满网搜索都是 nuxt 的 demo，就没有一个拿出点干货。</p><p>现在做技术，实在是有点太浮躁了，自以为写个 demo 就是会了一切。</p><p>其实整个迁移过程中，遇到的坑还有很多，但是有许多都是前端代码写的不够严谨，用法不规范导致，也不好意思拿出来。看到这篇文章的有缘人如果遇到什么问题无法解决，欢迎叨扰，或多或少我会帮得到您。</p></div><div class="article-licensing box"><div class="licensing-title"><p>前端项目迁移至 nuxt.js</p><p><a href="http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/">http://www.zzmark.top/2020/02/%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB%E8%87%B3nuxt/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Mark Zhou</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-02-22</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-02-22</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="link-muted mr-2" rel="tag" href="/tags/Vue-js/">Vue.js</a><a class="link-muted mr-2" rel="tag" href="/tags/Nuxt-js/">Nuxt.js</a><a class="link-muted mr-2" rel="tag" href="/tags/SEO/">SEO</a><a class="link-muted mr-2" rel="tag" href="/tags/SSR/">SSR</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share-cs"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js" defer onload="socialShare(&#039;.social-share-cs&#039;, { sites: [&#039;weibo&#039;, &#039;qq&#039;, &#039;wechat&#039;, &#039;twitter&#039;] });"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/static/img/alipay.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/static/img/weixin.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/04/remote-relay/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">用 wifi 模块配合继电器远程开机</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/02/id_3132532515/"><span class="level-item">Java 获取客户端真实 IP</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({el:"#valine-thread",appId:"cJJ78yRJRH9kx9ETc3Mlj8c5-gzGzoHsz",appKey:"fYCorgBhMRBEYlgJQvoLecCI",placeholder:"说点什么……",avatar:"wavatar",meta:["nick","mail","link"],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,enableQQ:!0,requiredFields:[]})</script></div></div></div><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen order-3"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#intro"><span class="level-left"><span class="level-item">1</span><span class="level-item">intro</span></span></a></li><li><a class="level is-mobile" href="#nuxt-js"><span class="level-left"><span class="level-item">2</span><span class="level-item">nuxt.js</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#生命周期"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">生命周期</span></span></a></li></ul></li><li><a class="level is-mobile" href="#框架搭建"><span class="level-left"><span class="level-item">3</span><span class="level-item">框架搭建</span></span></a></li><li><a class="level is-mobile" href="#迁移指南"><span class="level-left"><span class="level-item">4</span><span class="level-item">迁移指南</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#store"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">store</span></span></a></li><li><a class="level is-mobile" href="#pages"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">pages</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Router"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">Router</span></span></a></li><li><a class="level is-mobile" href="#生命周期钩子"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">生命周期钩子</span></span></a></li><li><a class="level is-mobile" href="#meta-标签"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">meta 标签</span></span></a></li><li><a class="level is-mobile" href="#keep-alive"><span class="level-left"><span class="level-item">4.2.4</span><span class="level-item">keep-alive</span></span></a></li></ul></li><li><a class="level is-mobile" href="#调试服务端"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">调试服务端</span></span></a></li></ul></li><li><a class="level is-mobile" href="#一些使用技巧"><span class="level-left"><span class="level-item">5</span><span class="level-item">一些使用技巧</span></span></a></li><li><a class="level is-mobile" href="#打包、优化"><span class="level-left"><span class="level-item">6</span><span class="level-item">打包、优化</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#项目精简"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">项目精简</span></span></a></li><li><a class="level is-mobile" href="#静态压缩"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">静态压缩</span></span></a></li><li><a class="level is-mobile" href="#css-分离"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">css 分离</span></span></a></li></ul></li><li><a class="level is-mobile" href="#其他-nuxt-js-的坑"><span class="level-left"><span class="level-item">7</span><span class="level-item">其他 nuxt.js 的坑</span></span></a></li><li><a class="level is-mobile" href="#后记"><span class="level-left"><span class="level-item">8</span><span class="level-item">后记</span></span></a></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/af01413b547f9ea694fb1d5b513c63b9?s=128" alt="Mark Zhou"></figure><p class="title is-size-4 is-block" style="line-height:inherit">Mark Zhou</p><p class="is-size-6 is-block">keep simple</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>北京</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">25</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ZzMark" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ZzMark"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zz_Mark06"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">八月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">七月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">四月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Blog/"><span class="tag">Blog</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTML/"><span class="tag">HTML</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Iot/"><span class="tag">Iot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nuxt-js/"><span class="tag">Nuxt.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SEO/"><span class="tag">SEO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSR/"><span class="tag">SSR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue-js/"><span class="tag">Vue.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/caddy/"><span class="tag">caddy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/https/"><span class="tag">https</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ide/"><span class="tag">ide</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/meta/"><span class="tag">meta</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tomcat/"><span class="tag">tomcat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tools/"><span class="tag">tools</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%8E%AF%E5%A2%83/"><span class="tag">环境</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E7%BB%B4/"><span class="tag">运维</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5036449195935522" data-ad-slot="5036449195935522" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mark Zhou</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load",()=>{window.cookieconsent.initialise({type:"info",theme:"edgeless",static:!1,position:"bottom-right",content:{message:"此网站使用Cookie来改善您的体验。",dismiss:"知道了！",allow:"允许使用Cookie",deny:"拒绝",link:"了解更多",policy:"Cookie政策",href:"https://www.cookiesandyou.com/"},palette:{popup:{background:"#edeff5",text:"#838391"},button:{background:"#4b81e8"}}})})</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})}))</script></body></html>