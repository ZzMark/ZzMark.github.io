<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>调律者</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="调律者"><meta name="msapplication-TileImage" content="/static/img/avatar.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="调律者"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="160x160" href="/static/img/avatar.jpg"><meta property="og:type" content="blog"><meta property="og:title" content="调律者"><meta property="og:url" content="http://www.zzmark.top/"><meta property="og:site_name" content="调律者"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.zzmark.top/img/og_image.png"><meta property="article:author" content="Mark Zhou"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zz_Mark06"><meta property="twitter:site" content="https://twitter.com/Zz_Mark06"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.zzmark.top"},"headline":"调律者","image":["http://www.zzmark.top/img/og_image.png"],"author":{"@type":"Person","name":"Mark Zhou"},"description":""}</script><link rel="icon" href="/static/img/avatar.jpg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.4.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?c3e99bfff793bb7f4d6646bc513afec5";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-154883003-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154883003-1")</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-5036449195935522" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="调律者" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/01/id_3075796319/"><img class="fill" src="/gallery/Thinkpad-E440-%E7%99%BD%E5%90%8D%E5%8D%95.png" alt="Thinkpad E440 白名单"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2021-01-12T07:41:23.000Z" title="2021-01-12T07:41:23.000Z">2021-01-12</time>发表</span><span class="level-item"><time datetime="2021-01-12T07:41:23.000Z" title="2021-01-12T07:41:23.000Z">2021-01-12</time>更新</span><span class="level-item">14 分钟读完 (大约2130个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/id_3075796319/">Thinkpad E440 白名单</a></h1><div class="content"><p>本文就是与白名单斗争的血泪史</p><p>白名单一共有两种对抗手段</p><ol><li>修改逻辑，废除白名单校验功能，直白的讲，就是有个判断，不让代码执行就ok了</li><li>修改数据库，让自己要换的卡成为bios支持的卡。原本支持三块无线网卡，把其中一个的id替换成新卡的id就行</li></ol><p>我最终使用了第二种 <code>修改数据库</code> 的方案，就是替换已有的硬件id</p><p>目前，网上修改白名单的教程，都太老啦，现在工具链比以前先进了很多(感谢vit9696大神的<a target="_blank" rel="noopener" href="https://github.com/LongSoft/UEFITool">LongSoft/UEFITool</a>)</p><p>所以我这里用了新的手段，更简单了</p><ol><li>读取bios</li><li>用 UEFITool 找到目标模块，配合 二进制编辑器(我用的 HxD) 替换某块已存在的网卡</li><li>烧录回去</li></ol><p>但是，因为intel的安全限制，更新bios是有校验的，笔记本无法随便刷 bios，也就是你改完了bios，却没法用原本的软件刷入</p><p>所以，想要修改 bios，需要直接用编程器去烧录 bios 芯片<br><img src="/2021/01/id_3075796319/2.png" alt="淘宝随便搜的，第三个烂大街的，是山寨货，能用但坑不浅，后面会说"></p><p>以下就是翻车全过程</p><ul><li>e440 的 bios 分为两个芯片存放，64MBit的 Bios，32MBit的 EC</li><li>我有编程器，但是个山寨货，满淘宝都是同款山寨，毕竟就只是个SPI串口烧录，没有核心技术。开源的板都抄不明白必须得告别这个行业了。</li><li>山寨烧录器配的烧录软件，也是破解版本，最大的坑点，也是翻大车的理由</li><li>官网的 bios 文件，是 12Mbyte(注意单位，1Mbyte = 8MBit)，我没有分离手段，也就是我只能靠备份来拿原始 bios</li></ul><p>我不太想拆 bios，考虑过 SOP 夹子，但这东西，用过的都知道，十几块的玩意就跟一次性一样，而这个笔记本有俩芯片，</p><p>所以我最终选择了这个东西<br><img src="/2021/01/id_3075796319/3.png" alt="没有考虑尺寸"></p><p>但是买的时候，忘记考虑尺寸，到手发现，根本夹不上去，最后还是上烙铁焊下来</p><p><img src="/2021/01/id_3075796319/4.jpg" alt="准备把EC装回去时的照片"></p><h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><blockquote><p>买编程器的时候，都会有配套的软件，鉴于很多人购买的 CH341A 编程器是山寨产品、软件均是破解来的盗版（正版：skygz.taobao.com）<br>破解来的软件非常不好用（芯片支持不够、报错闪退等）<br>所以，强烈建议大家丢弃那个破软件<br><img src="/2021/01/id_3075796319/5.png" alt="网上借来的图"><br>满网都是盗版，各种投毒，支持芯片少之又少。<br>推荐使用 AsProgrammer，有 dalao的汉化，还有简单的说明：<a target="_blank" rel="noopener" href="http://www.smxdiy.com/thread-1195-1-1.html">介绍一款 CH341A 编程/烧录 软件 AsProgrammer 汉化版</a></p></blockquote><p>读取的过程，没啥的。</p><p>我的主板，bios和ec是分成两个芯片的，型号分别为 <code>winbond 25q64fvsig</code> 和 <code>winbond 25q32fvsig</code>，之前已经提到，32MBit的是EC，64MBit的是bios(我怎么知道的？没什么神奇的，翻资料)</p><p>thinkpad 的白名单功能，在EC中，所以需要读取的是 32MBit 的那个。</p><p>软件那边，能识别出芯片，就是没问题，具体的芯片型号可以直接看芯片的丝印</p><blockquote><p>若识别错误，可能是接触不良，去排查线路。</p></blockquote><p>读取过程，一定要多读取几次，不要怕耽误时间。</p><ul><li><p>多次读取后，把每一次的都丢进 <code>文件 crc32</code> 算一下是否一致</p></li><li><p>这个可以随便找在线工具，比如这个 <a target="_blank" rel="noopener" href="http://tools.jareye.com/crypto/fileverify.html">文件校验</a></p></li></ul><p>最好是读取三次，都一致就ok，若有不一致的，再读几次，确保大部分都是一致的，那个版本基本不会是损坏的</p><h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p>网上各种教程会让你使用 PhoenixTool 解包，用xsearch搜索，再修改，然后用工具打包。这一堆操作很容易出问题，所以我用更加便捷的工具来做这个。感谢vit9696</p><p>所需工具，一共两个，</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/LongSoft/UEFITool">LongSoft/UEFITool</a></li><li>HxD 或者 winhex</li></ul><p>下载 UEFITool 时，注意版本，带NE的版本只有查看和提取能力，不能替换。我们需要不带NE的完全版本，替换模块</p><p><img src="/2021/01/id_3075796319/6.png" alt="单独打开EC肯定会有警告，无视就好"></p><p>首先掌握一个基本技能，就是转换硬件id</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 参考网卡，rtl8723be 到设备管理器中寻找。没有留图</span><br><span class="line">PCI\VEN_10EC&amp;DEV_B723&amp;SUBSYS_B72817AA&amp;REV_00</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 提取每一部分，然后丢弃 REV (似乎这个不能丢弃，硬件id中有 REV01可能需要保留，但大部分都没有，起码我这个没有)</span><br><span class="line">10EC B723 B72817AA 00</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 反写</span><br><span class="line">EC10 23B7 AA1728B7</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 去掉空格，这就是最终结果，ec中存放的数据都是这个</span><br><span class="line">EC1023B7AA1728B7</span><br></pre></td></tr></table></figure><ol><li><p>定位要提取的模块<br>白名单中肯定包含当前的卡<br>搜索 Hex Pattern: header and body: <code>EC1023B7AA1728B7</code><br><img src="/2021/01/id_3075796319/7.png" alt="header and body"><br>当然，搜索 Text : <code>Unauthorized network card is plugged</code> 记得区分大小写，这句话来源于触发白名单时，屏幕上的提示</p></li><li><p>提取模块<br>双击搜索结果，就能定位到我们要找的地方。<br><img src="/2021/01/id_3075796319/9.png" alt="LenovoWmaPolicyDxe"><br>右键 <code>Extract body</code> 提取出这个部分即可<br>如果点击下面那一行的 User interface，可以在右侧看到 <code>Text: LenovoWmaPolicyDxe</code>，就是这个模块的名字</p></li></ol><h2 id="修改白名单"><a href="#修改白名单" class="headerlink" title="修改白名单"></a>修改白名单</h2><p>这里采用了替换法，找一个替死鬼换掉即可</p><p>用二进制编辑工具，打开提取出的模块</p><p>搜索 <code>EC1023B7AA1728B7</code>，能看到三个网卡的硬件id<br><img src="/2021/01/id_3075796319/10.png" alt="三个硬件id"></p><p>选择其中一个做替死鬼，将新网卡的id写入即可</p><p>保存，然后使用 UEFITool 替换刚刚提取的那个模块</p><p><code>右键-Replace Body</code></p><p>然后保存，保存的结果就是修改好的 EC</p><p><img src="/2021/01/id_3075796319/20.jpg" alt="杂乱的笔记"></p><h2 id="烧录回去"><a href="#烧录回去" class="headerlink" title="烧录回去"></a>烧录回去</h2><p>将修改好的EC，刷回去，就行了</p><h2 id="翻车记录"><a href="#翻车记录" class="headerlink" title="翻车记录"></a>翻车记录</h2><p>我翻车的理由，要怪那个山寨的破解软件，不支持我的芯片，我还没有注意到</p><p>结果我修改了一个损坏的 EC，刷回去时也是损坏的。</p><p>最终，只能淘宝买一份原始 Bios，重新修改，两个都拆下来，两个都刷到原始版本，最终解决了问题</p><p>痛恨这傻逼的软件</p><h2 id="另一种尝试"><a href="#另一种尝试" class="headerlink" title="另一种尝试"></a>另一种尝试</h2><p>其实，我还做了另一种尝试，虽然只走到了一半。</p><p>这个尝试极其复杂，外行止步</p><p>首先，额外需要的软件有</p><ul><li>IDA Pro 用于反汇编，若要更好的分析流程，最好找个破解版，带 decompiler 反编译器的</li></ul><p>其次，需要一个常识</p><ul><li>这种涉及到偏移量的汇编，不要妄图增加一个赋值操作，或者删除某些代码，那需要重编译，否则容易导致破坏原有的执行，反而出现bug</li></ul><p>思路就是，找到关键代码，桥接掉</p><p>顺着 <code>Unauthorized network card is plugged</code> 开始查找，可以找到以下函数 <code>sub_690</code></p><p><img src="/2021/01/id_3075796319/11.jpg" alt="目标方法"></p><p>这段代码决定了打印错误内容</p><p>通过 IDA 找到哪里调用了这个函数<br><img src="/2021/01/id_3075796319/12.jpg" alt="目标方法"></p><p>图中的 <code>while(1) ;</code>，就是祸首</p><p>找到对应的汇编</p><p><img src="/2021/01/id_3075796319/13.jpg" alt="目标方法"></p><p>然后，就是如何跳转到正确的位置</p><p>需要修改的时</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loc_826:</span><br><span class="line">...</span><br><span class="line">call  sub_690 &#x2F;&#x2F; 从这里开始，让代码跳转到下边的 loc_845</span><br></pre></td></tr></table></figure><p>可惜，我专业能力不足，不晓得怎么跳转……</p><p>毕竟我一点汇编都没学过……</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>资源下载</p><ul><li><a target="_blank" rel="noopener" href="http://www.smxdiy.com/thread-1195-1-1.html">介绍一款 CH341A 编程/烧录 软件 AsProgrammer 汉化版</a></li><li><a target="_blank" rel="noopener" href="https://github.com/LongSoft/UEFITool">LongSoft/UEFITool</a></li><li>Hxd</li><li>e440 (型号: 20c5 ver: 2.22 board: nw-151a) 工厂 Bios</li></ul><p>其余的稍后补充</p></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2021-01-09T09:03:23.000Z" title="2021-01-09T09:03:23.000Z">2021-01-09</time>发表</span><span class="level-item"><time datetime="2021-01-09T09:03:23.000Z" title="2021-01-09T09:03:23.000Z">2021-01-09</time>更新</span><span class="level-item">10 分钟读完 (大约1490个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/id_3598269465/">Thinkpad E440 升级记录</a></h1><div class="content"><p>陪伴了我6年的笔记本，折腾了这么久，整理一下笔记</p><h2 id="before"><a href="#before" class="headerlink" title="before"></a>before</h2><p>这笔记本，也算是被我拉到一定高度了，能升级的各种升级，能拉到顶的基本都往顶上拉</p><p>联想的老本子(16年前的型号)大多数都有 pcie 白名单，也就是没法随心所欲换无线网卡</p><p>原本配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CPU: i5 4200m(双核四线程 2.5GHz&#x2F;3.1G TDP 37W)</span><br><span class="line">显卡: Nvidia Geforce GT840M 总之够弱</span><br><span class="line">内存: 4G ddr3 1600</span><br><span class="line">硬盘: WD 500g 5400rpm 7mm 薄盘</span><br><span class="line">屏幕: 1366 x 768 京东方辣眼屏幕(不是诋毁京东方，只是这块屏太低端了)</span><br><span class="line">有线网卡: RTL8111 后边啥忘了，普通的千兆卡</span><br><span class="line">无线网卡: RTL8723BE, wifi单2.4g 300m，蓝牙4.0，双天线，mpcie</span><br></pre></td></tr></table></figure><h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>升级过后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CPU: i7 4710mq(四核八线程 2.5GHz&#x2F;3.5G TDP 47W)</span><br><span class="line">显卡: Nvidia Geforce GT840M 显卡我也换不了</span><br><span class="line">内存: 8G ddr3 1600 x2，拉满16g内存</span><br><span class="line">硬盘: 镁光 m550 240g, 老机器剩下的</span><br><span class="line">屏幕: 友达 b140han01.7 1920 x 1080 ips 就是薄了点，孔位不对，上了胶水</span><br><span class="line">有线网卡: RTL8111 后边啥忘了，普通的千兆卡</span><br><span class="line">无线网卡: intel 7260ac, wifi 双频 300&#x2F;867，蓝牙4.0，双天线，mpcie，不支持mu-mimo，除了魔改安装白果原装卡之外最高的型号了</span><br></pre></td></tr></table></figure><h3 id="屏幕"><a href="#屏幕" class="headerlink" title="屏幕"></a>屏幕</h3><p>屏幕升级是16年的事，只记得原装屏幕和这个差了0.5mm厚度，所以屏幕有缝隙；下边孔位对不上，最后拿胶水粘上的。<br>总之最终效果很好</p><p>笔记本换屏幕，确保接口一致，电压一致，就ok。当然记得注意接口带宽够不够。比如朋友的 dell 灵越7537 768p的就没法直接换1080p，需要补主板上的零件</p><p>附上辣鸡原装屏淘宝的价格(16年换屏幕时候，原装屏80块就能收到)<br><img src="/2021/01/id_3598269465/1.png" alt="如今这破屏幕也贵了不少"></p><h3 id="cpu"><a href="#cpu" class="headerlink" title="cpu"></a>cpu</h3><p>这一代笔记本可以换cpu，有几个可选的目标，</p><ul><li>qdet，不显ES，应该只有一两百块，有赌的成分，性能基本等同于 4700mq</li><li>i7 4700mq/4710mq，两者区别不大，价格也是</li><li>i7 4800mq，太热，必须关掉超线程才能快乐玩耍</li><li>i7 4770hq PGA转接，性能比4800mq强一丢丢，核显是 irs 5200，虽然没啥大用。现在不好买到了</li></ul><p>当然，4700mq，性能也就只有 amd ryzen r5 4600u 的一半。感慨时代变迁啊<br>(不过人家6c12t，咱4c8t，差这么多年，输了不丢人)</p><blockquote><p>先纠正一个点，TDP不是功耗<br>intel 的解释 <a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/support/articles/000055611/processors.html">英特尔®处理器中的散热设计功耗（TDP）</a>。<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/22052609/answer/252695598">TDP能否看作CPU与GPU的额定功率? - 黎小白的回答 - 知乎</a></p></blockquote><h3 id="无线网卡"><a href="#无线网卡" class="headerlink" title="无线网卡"></a>无线网卡</h3><p>白名单内只支持三个卡<br>e440 20c5 一共支持三块无线网卡，分别是</p><ul><li>rtl8723be</li><li>intel n-7260(单频版本)</li><li>intel 7260ac(官方文档说支持，但bios里的硬件id还是单频的版本，不晓得官方说的是哪个型号)</li></ul><p>以下内容均基于修改白名单。</p><p>可选项其实没几个，因为 minipcie 实在是没啥新卡了</p><p>不外乎两个思路，转接/不转接</p><p>e440 无线网卡仓位，是标准的半高 mini-pcie 27mm x 30mm ，单侧螺丝柱，垂直方面还是有不少余地，可以大胆上转接卡，不会被厚度限制</p><p>长度其实也很足够，能塞下全高 mini-pcie 27mm x 51mm 的仓位，若是转接卡没有留半高的螺丝孔位，也可以自己拿胶水粘上，不会出问题(当然，胶水要靠谱才行)</p><p>转接的话，必然是 mini-pcie to ngff(m.2)，可选卡就挺多了。几个个人推荐</p><ul><li>intel ax210 100块 (最新卡，特性很全，支持wifi6e，蓝牙5.2，需要重新拉天线，自带天线没法跑6G)</li><li>intel ax200 60块 (intel 比 ax210 旧一代的卡，wifi6，蓝牙5.1，也算是笔记本能用最好程度)</li><li>博通 BCM943602BAED，戴尔的 DW1830，天价，没啥意思</li></ul><p>m2 无线网卡一般的尺寸都是 2230，用转接卡肯定要长于原本的长度，若是转接卡没有留螺丝孔，那就</p><p>还有白果原装卡，需要特制的转接卡(毕竟接口不同)，驱动找 bootcamp 中提取，就像是白果装 win 那样</p><ul><li>bcm943602CS 大概要200块。15年的卡，450/1300，蓝牙4.1，(我刚知道这卡的时候，60块就能拿到……)</li><li>bcm94360cd，最高规格(大概)的卡，13年的老卡，四天线卡(3t3r，蓝牙单独一根)，蓝牙4.0，不推荐使用<ul><li>(450/1300)，容易遇到魔改版本 2.4g 600m的怪胎</li></ul></li><li>bcm94360cs2，这是老卡，不推荐，也不便宜</li><li>BCM94360CSAX，也是老卡，不推荐，也贵得要死</li></ul><p>若是非转接，那就只有两种选择了</p><ul><li>intel 7260ac，50块 wifi 双频 300/867，蓝牙4.0，双天线，不支持mu-mimo</li><li>博通 bcm94352z，贵</li><li>博通 bcm94360hmb 三天线卡，贵得很</li><li>高通的卡，我不了解</li></ul><p>我对苹果的无线算是很了解，但出于成本和复杂度，我最终选择了 7260ac，毕竟折腾 ax200 也没啥意思，转接卡也要三四十块</p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ul><li><p>我还考虑要改散热，现在的u还是太热了，或许我也可以考虑关掉超线程。</p></li><li><p>也在考虑是否能加上个 wwan 卡，目前还在调查中</p></li><li><p>电池其实也不太行了，损耗达到了50%，不过用的也很少，可能短期内不考虑这个了</p></li></ul></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2021/01/windows-planning-and-install/"><img class="fill" src="/gallery/windows10%E4%B8%8B%E8%BD%BD.png" alt="Windows-系统规划、系统重装、系统优化"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2021-01-07T05:52:01.000Z" title="2021-01-07T05:52:01.000Z">2021-01-07</time>发表</span><span class="level-item"><time datetime="2021-01-07T05:52:01.000Z" title="2021-01-07T05:52:01.000Z">2021-01-07</time>更新</span><span class="level-item">34 分钟读完 (大约5085个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/windows-planning-and-install/">Windows-系统规划、系统重装、系统优化</a></h1><div class="content"><style>.content h2,.content h3,.content h4,.content h5{color:#3273dc}</style><blockquote><p>本文写自 2020-12-28 日，后半的内容都是在讲故事，重点都在前面<br>里面的图不是同一台电脑截出来的，不要挑刺</p></blockquote><p>文字极多，我不太会做教程那种啰嗦东西，随便看吧</p><p>想到什么，我会慢慢往上更新</p><hr><p>如今已经 2020 年了，坚持 xp 天下第一的，建议你去看看医生，让医生纠正一下你的 xp 系统</p><p>坚持 win7 天下第一的，如果能说出三个你日常使用下 win7 能做，win10 不能做的东西，那么只有两种情况</p><ol><li>你的使用场景真的离不开 win7</li><li>你对系统的理解已经超越了我</li></ol><p>以上两种，我都建议右上角关闭这个页面，不要浪费彼此的时间</p><p>以下内容，全都是基于 <code>GPT分区</code> <code>UEFI引导</code> <code>windows 10</code> <code>非LSTC版本</code>，如果你不知道其中的是啥，可以无视，确保你的电脑是2012年(intel 初代i3/i5/i7, amd AM3插槽)后出产的型号就行</p><h2 id="before"><a href="#before" class="headerlink" title="before"></a>before</h2><ul><li>下文中出现的 C 盘，一律是系统盘的意思，怕有些人脑子转不过来</li><li>下文提到的 chrome，要么指代 <code>Google Chrome 浏览器</code>，要么指代 <code>开源的 Chromium 内核</code>，因为很多情况把 <code>Chromium 内核</code>叫成 <code>chrome 内核</code>也没什么问题，所以自行判断</li></ul><h2 id="辟谣"><a href="#辟谣" class="headerlink" title="辟谣"></a>辟谣</h2><blockquote><p>如今互联网十分发达，获取知识的成本也变得低廉。<br>但验证言论的成本越发变高，所以谣言总使比真话传得更快更广，更深得人心</p></blockquote><p>每次看到网上传播的那些个谣言，总让人想到这句话</p><blockquote><p>您还在用番茄花园吗，2020年了，不是2002年</p></blockquote><p>让我们辟几个谣，贴上了目前能想到的几点。</p><p>以下几点，都是错的</p><ol><li><p>软件不能装 C 盘，系统会变慢</p><blockquote><p>软件装在哪里，速度都是一样的，速度不一样，只可能是你的硬盘有问题</p></blockquote></li><li><p>软件装 C 盘太占地方，C 盘空间宝贵</p><blockquote><p>用得多的人都知道，真正占地方的东西，都是些用户数据、缓存、临时文件，就算安装到其他盘，该占 C 盘的，还是占 C 盘</p></blockquote></li><li><p>装系统时候，要分 CDEF 四个区，系统，软件，游戏，文档要分开放，玩游戏把硬盘弄坏了另外两个分区也不会受损</p><blockquote><p>真要是硬盘弄坏了，只可能整个硬盘都挂掉，管你什么CDEFG分区都会死</p></blockquote></li><li><p>不装杀毒软件，就该中病毒了；不装安全软件，就不安全了</p><blockquote><p>不安装杀毒软件，确实风险挺大，但现在 win10 送的杀毒很猛，完全不用操心。<br>当然，防君子不防小人，你直接给了某个恶意软件超高的权限，还是会死<br>就算防了小人，也防不住手欠的，你自己关掉了各种更新，遇到漏洞入侵然后说不安全，我该说些什么</p></blockquote></li><li><p>你这 Chrome 是美国的，不安全，咱们中国人得用中国的产品</p><blockquote>国产……十年前国产车还是低端的代名词。国产浏览器，内核都是 chrome 的，美国心，只是有一个国产皮肤罢了<p>= 某60安全浏览器，把本应有的功能包装成会员专享，实在是软件工程的典范</p><p>= 18年国产自主研发，红芯浏览器，被爆出 chrome 换皮</p><p>= <a src="https://www.zhihu.com/question/290564335/answer/472165753">[自主研发一款浏览器内核的难度到底有多大？ - 罗志宇的回答 - 知乎]</a></p></blockquote></li><li><p>自动更新总是让我电脑关不了机/总使提示我重启/更新后游戏就没法玩了/每次都更新失败，开着也没用</p><blockquote><p>面对这种人，只能说微软实在太好心了，老掉牙的危险版本依然能让你用，<br>你看看 iOS，看看 Mac X OS，强制更新，不更新用个鸡儿，新软件全都不让安装<br>您信任那些安全软件的漏洞修复，却不信任最了解这系统的人给你提供的安全更新，<br>如果您对操作系统的理解远超微软，您可以给微软发个邮件，探讨一下系统更新应不应该从 windows 去掉</p></blockquote></li></ol><h2 id="系统规划"><a href="#系统规划" class="headerlink" title="系统规划"></a>系统规划</h2><p>对于系统的规划，主要还是磁盘分区的规划，文件方面的规划，和系统优化方面的内容</p><p>系统优化，先讲讲我对优化这个行为的看法。</p><blockquote>如今个人电脑的性能十分足够，现在的 windows，也没什么值得优化的点了<p>所以我个人是拒绝任何无脑优化的</p><p>当然，针对性的，比如说怎么跑满 100g 网卡，怎么驱动 RDMA，怎么插 4 块 nvme 固态还能跑起来</p><p>但是这些，大家应该都听不懂，说了也没啥意思</p></blockquote><h3 id="分区规划"><a href="#分区规划" class="headerlink" title="分区规划"></a>分区规划</h3><p><img src="/2021/01/windows-planning-and-install/1.png" alt="128固态 + 500g机械，剩余量做了其他用途"></p><p>我个人是不太喜欢分区的，反正分了区，也不会让文件变整洁，还要去区分哪个分区怎么用，想想就头疼。</p><p>但我个人还是拒绝单分区的，推荐将操作系统分离开来。<br>这样重装系统时，可以减少备份的考虑，反正重装了系统，软件也是要重装的，自己的文件绕开C盘就好了</p><p>思路很明确，</p><ul><li>100g~200g 系统分区，有空间就大点给着</li><li>固态有剩余，分配个固态的分区</li><li>剩下的一个分区一块盘</li></ul><p>接下来都是个人见解，大体上区分成了几种情况，思路都是一致的</p><ul><li><p>128g 固态</p><p>就这么点地方，您还是别瞎折腾了</p></li><li><p>128g/256g 固态 + 机械硬盘</p><p>这种场景我的分法是，<br>C(128g 固态), D(机械)</p></li><li><p>512g/1t/2t固态 + 机械硬盘</p><p>C(128g 固态), D(剩余的固态), E(机械)</p></li><li><p>多块固态</p><p>方案1：适合大众。系统盘给操作系统上100~200G，剩下的分给一个分区，其他固态每个固态一个分区</p><p>方案2：跨区卷走起，当然，别存重要资料，小心集体爆炸</p></li></ul><p>说说理由，其实上面都已经说过了</p><ul><li>单纯的 win10 操作系统大概给 100g 以上就差不多够用，也得看软件和其他的数据文件占用多少。虽然经常看到C盘占用率到80%，不过无所谓，煮不在乎。软件多的话就多给一些</li><li>许多软件重装系统也必须重装，所以没必要非得绕开C盘<ul><li>当然，绿色软件可以放到D盘，或者软件十分的多，不想占用宝贵的固态空间，也可以换到其他磁盘上</li></ul></li><li>我的文档、下载、桌面，记得迁移到非C盘（后面有图）</li></ul><h3 id="文件规划"><a href="#文件规划" class="headerlink" title="文件规划"></a>文件规划</h3><blockquote>你们奉为设计的苹果，mac x os，并不存在 CDEF 磁盘分区<p>当然，苹果也没打算让一般用户在机器上安装多块硬盘</p></blockquote><p>磁盘分区规划中已经提到的一点，软件放哪里无所谓，自己用户文件不要乱丢就好。</p><p>如果为了重装系统考虑，把不可再生的用户数据(比如自己做的ppt、照片、word等等)，移出 C 盘</p><p>我个人有整理文件的习惯，自己的文件位置都放的比较规整。</p><p><img src="/2021/01/windows-planning-and-install/5.png" alt="现在一些文件都丢到nas里，这也就比较干净了"></p><p>对于软件产生的文件，我倾向于默认位置，减少各种配置时要考虑的情况，出了问题可参考的内容也多</p><blockquote><p>比如 maven 的仓库，默认就是 <code>~/.m2</code> ，配置文件就在这里<br>qq 的聊天记录，默认放到 <code>文档</code> 中，因为 文档 已经移动到其他分区，也不会无限占用 C 盘空间，重装恢复难度为0<br>软件安装路径，基本都是默认位置，有一些很大的、跟系统无关的，可能会修改个盘符<br>从 <code>c:\Program Files(x86)\xxxxx</code> 改成 <code>d:\Program Files\xxxxx</code><br>抹掉 (x86) 这烦人字样，反正 windows 10 没啥必要区分 32位 还是 64位<br>当然，一些绿色软件，也会放到这里<br>软件的安装包、或者自己的一些免安装小工具，那就指不定在哪了</p></blockquote><p>关于整理文件，分享我自己的整理习惯</p><ul><li>软件安装到 <code>Program Files</code></li><li>用户文件直接迁移到 <code>Users/xxxxxx</code>，保持原有目录结构，就是简单换了个分区</li><li>干活的东西(可能不止一个种类，所以每个种类建议分离开)，找个地方集中放好<ul><li>平常写的工作代码，都在 <code>workspace/&#123;项目名称&#125;/&#123;工程名称&#125;</code></li><li>github 或者一些个人积累代码，都在 <code>github/&#123;项目名称&#125;/&#123;工程名称&#125;</code></li><li>视频处理工程(偶尔还会帮家里人剪个视频)，<code>cut/&#123;日期&#125;/&#123;工程名称&#125;</code></li><li>文档类的，<code>code/&#123;类别&#125;/&#123;啥项目&#125;</code></li></ul></li><li>游戏，<code>Games/&#123;游戏名&#125;</code>，steam：<code>Games/Steam/SteamLibrary</code>，steam本体在c盘默认位置</li><li>照片、截图之类的<ul><li><code>照片/手机照片/&#123;手机型号&#125;/DCIM</code> 型号不同，文件名规则有可能不同。自增的id也可能冲突，所以每个手机单独存放。现在靠nas同步，不用担心同一个手机拍出相同的id了<br><img src="/2021/01/windows-planning-and-install/6.png" alt="没有nas的时候"></li><li><code>照片/手机照片/&#123;日期&#125;/DCIM</code> 没有nas的时候，手动复制，按日期搞就行，冲突自己有办法解决</li><li><code>照片/&#123;相机型号&#125;/&#123;日期&#125;/DCIM</code> 以前还有相机用的时候，也存了一些这样的东西</li></ul></li><li>音乐，迫于网易云全灰，我对云产品的信任真是一天比一天差。所以音频文件都是本地化的<ul><li><code>music/cd/&#123;歌手-专辑名&#125;/xxxxx</code></li><li><code>music/CloudMusic/&#123;歌手&#125;/&#123;专辑&#125;</code></li></ul></li><li>下载的电影、视频、大压缩包 <code>下载/&#123;下载软件&#125;</code> 按软件分开管理，每个下载软件下的东西倾向不同，</li><li><code>系统相关</code><br><img src="/2021/01/windows-planning-and-install/7.png" alt="现在也丢进nas了"></li></ul><p>顺便，送各位一个工具 <a target="_blank" rel="noopener" href="http://www.uderzo.it/main_products/space_sniffer/">SpaceSniffer</a>, 可以查看是哪个文件夹占用了您的宝贵硬盘空间</p><p>官网是意大利的，若下载不动，这里有下载好的文件<br><a target="_blank" rel="noopener" href="https://download.zzmark.top/SpaceSniffer.exe">我转存的/SpaceSniffer</a></p><h3 id="Windows-推荐配置"><a href="#Windows-推荐配置" class="headerlink" title="Windows 推荐配置"></a>Windows 推荐配置</h3><p>我个人反感魔改系统，所以，这些修改都是遵循 Windows 提供的选项，没有危险操作</p><p>按照推荐程度，从上到下</p><ol><li><p>把 我的文档、桌面、默认下载文件夹，都移动到其他分区上</p><blockquote><p>这样可以将用户常用的位置都迁移到其他地方。不要让 qq 微信 打爆系统盘</p></blockquote><ul><li>打开 <code>计算机(我的电脑)</code>，在左侧找到<code>桌面</code>、<code>文档</code>、<code>下载</code> 等等想要迁移的</li><li>点击右键 - 属性 - 位置选项卡，将路径调整好，我个人倾向于维持原有文件夹名称，迁移到d盘。</li><li>确定即可，会提示是否移动文件</li><li>over<br><img src="/2021/01/windows-planning-and-install/2.png" alt="属性"></li></ul></li><li><p>对于文件管理器，做一些配置。在文件夹选项中</p><blockquote><p>防止最低级的病毒，以及恶意软件</p></blockquote><ul><li>显示隐藏文件，</li><li>隐藏系统文件(推荐)</li><li>显示文件的扩展名</li><li>隐藏文件夹合并通知<br><img src="/2021/01/windows-planning-and-install/3.png" alt="推荐的设置"></li></ul></li><li><p>使用平铺这种布局，更容易一眼找到想要的文件。</p><blockquote><p>还能看到一点缩略图，各方面都很均衡<br>我个人是不喜欢 windows vista 之后将列表设置为默认的<br><img src="/2021/01/windows-planning-and-install/8.png" alt="左边详细信息-右边平铺"></p></blockquote></li></ol><ul><li>文件管理器上方 - 查看 - 平铺</li><li>文件管理器上方 - 查看 - 选项 - 查看选项卡 - 应用到文件夹，可以将当前文件夹的布局应用到所有同类文件夹</li></ul><ol><li>合并任务栏，默认情况下会始终合并任务栏，很不直观，个人更倾向于使用 <code>当任务栏已满</code> 这种，能让打开的东西都显示出来。<blockquote><p><img src="/2021/01/windows-planning-and-install/9.png" alt="文件管理器因为太多被折叠了"></p></blockquote><ul><li>具体配置为，任务栏点击右键 - 任务栏设置<br><img src="/2021/01/windows-planning-and-install/4.png" alt="当任务栏已满"></li></ul></li></ol><h2 id="重装系统"><a href="#重装系统" class="headerlink" title="重装系统"></a>重装系统</h2><p>对于磁盘规划，之前也说过，用户数据(文档、下载、桌面) 都不在C盘种，所以我的电脑可以直接抹掉C盘重装系统，丝毫不用犹豫丢了重要文件</p><p>关于安装系统，自从 windows 10 1511 版本以后，MSDN的 iso 内核心的wim文件也超过了 4g，没法直接写iso或者找个u盘随便装，很是麻烦。</p><p>但，微软爸爸提供了更加方便的操作，官方工具，插上u盘直接制作安装盘，一键操作，长手就能用，只需要U盘大小大于8G小于32G(大于32g也有办法，只不过略微麻烦，小白直接无脑16g就好了)</p><p><a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/software-download/windows10">下载 Windows 10</a></p><p>安装过程全中文，网页下边还提供了教程，不傻就能看懂。</p><p>不过还是说几句，</p><ul><li><p>新机器安装系统时，建议安装阶段只给一个系统分区，避免不小心把系统装歪了地方</p></li><li><p>老机器重装系统时，用磁盘容量来确认是哪个分区，因为那个界面并没有 CDEFG 之类</p></li></ul><hr><h2 id="闲谈无聊的过去"><a href="#闲谈无聊的过去" class="headerlink" title="闲谈无聊的过去"></a>闲谈无聊的过去</h2><blockquote><p>文章末尾，其实没什么用，讲讲故事了</p></blockquote><p>故事中的那些傻子，肯定不是我。</p><p>我对于装系统这项技能的掌握很早，05年跟着电脑店的师傅学习过，07年自我尝试，09年后半就已经开始用上win7了，那时候还叫开发者预览版（?）</p><p>无师自通，师从外行，都是让人绕弯子的东西，但绕过的弯子，也让我理解了很多基础的东西，虽然现在眼界专业了，看着就跟玩笑一样</p><h3 id="C盘？其他的盘？有什么区别"><a href="#C盘？其他的盘？有什么区别" class="headerlink" title="C盘？其他的盘？有什么区别"></a>C盘？其他的盘？有什么区别</h3><p>以前玩多系统的时候，曾经做过操作系统在 F 盘的情况</p><p>当时身边的人很诧异，就问我，你这C盘咋没了呢</p><p>当时的情况是这样</p><ul><li>分区1 win7(C)</li><li>分区4 win8(F)</li></ul><p>切换系统时，将另一个系统的分区隐藏掉。也就只有 D E F 然后系统 logo 标记在了 F 上</p><p>这是个认知错误，并没有规定系统只能安装到 C，也并没有规定过 C 一定要存在</p><hr><p>当然，这之后，我把 F 改成了 C，情况更有趣了</p><ul><li>分区1 win7(C)</li><li>分区2 (D)</li><li>分区3 (E)</li><li>分区4 win8(C)</li></ul><p>切换系统时，将另一个系统的分区隐藏掉</p><p>有很多人认为，CDEF 就是按照顺序排下来的。实际上，这也只是打了个标签而已，顺序都是随意的</p><p>嗯，当时也是震惊了很多身边半懂不懂的人</p><h3 id="传统引导-UEFI-过渡-时期的混沌"><a href="#传统引导-UEFI-过渡-时期的混沌" class="headerlink" title="传统引导 - UEFI 过渡 时期的混沌"></a>传统引导 - UEFI 过渡 时期的混沌</h3><p>距今最近的混沌时期，就是 传统引导 - UEFI 过渡的那个时期了</p><p>这个过渡期本应是 windows 7 的那个时代，也就是 10 11 12年，在微软的 vista 暴死之后</p><p>但那之后，win7 接手，这个系统过于成功，让那个过渡期并没有什么犹豫，多数人都是选择放弃 UEFI 引导的</p><p>所以这个过渡期被顺延到了 win8 的时代</p><p>首先，win7 可以在 CSM 技术加持下支持 UEFI 引导的，但因激活手段太差(传统引导的 OEM7F7 工具实在是太猛了)，并没有人想用</p><p>而且，UEFI 的 win7 也没什么优势，毕竟那会固态还不普及，开机速度更多还是硬盘限制</p><p>win7 过于成功，现在还存在 win7天下第一的神教，我都怀疑这波人就是当年吹 xp强于win7的那一群</p><p>就因为win7这帮人，到了win8的时代，也就出现了很多麻烦的事情</p><p>比如，自认为有两把刷子的小白给win8重装，还想着老一套 Ghost 还原方案，结果发现无法开机，各种翻车。原因在于 win8 出厂都是 UEFI 引导，有些人查到了百度的二手资料，得知要调整为 Legacy boot，但 Bios 里那一项却不让调整，就说电脑垃圾，win8 垃圾。</p><p>经历坎坷，关掉了 Security boot，后，装上了 win7，然后发现芯片组驱动不起来，usb不好用，声卡没声音，毕竟win8 的驱动没法给 win7 用，而很多笔记本没提供 win7 驱动，几乎是死局</p><p>以前的 PC 有一个叫法，称为 <code>IBM PC 兼容机</code>，现在的 PC 规范由多个公司组织联合制定，硬件型号相同，驱动也有很大程度的通用性。<br>所以这个混沌的年代成功倒退了回去，只要单独安装驱动，就可以让不提供 win7 驱动的 笔记本，安装 win7 操作系统。又不是不能用</p><h3 id="装系统的本质"><a href="#装系统的本质" class="headerlink" title="装系统的本质"></a>装系统的本质</h3><p>这不算是个故事，算是个人理解。</p><p>装系统的本质？</p><ol><li>解压缩</li><li>将解压缩的结果，引导起来</li></ol><p>Over.</p><p>等等，就这？</p><p>没错，就这。</p><h3 id="谈论引导，以及多系统共存"><a href="#谈论引导，以及多系统共存" class="headerlink" title="谈论引导，以及多系统共存"></a>谈论引导，以及多系统共存</h3><p>我对于引导的研究，更多的在于传统引导</p><p>那个年代很纯真，启动盘的活动分区的引导扇区，就那么点容量，读取出来执行代码，来决定如何引导操作系统</p><p>UEFI 其实更简单粗暴，也更灵活了，</p><ul><li>第一个 fat/fat32 分区</li><li>/EFI/BOOT/BOOTX64.efi (不区分大小写)(只是默认情况，实际可以根据主板内写入的引导项指向其他文件)</li></ul><p>.efi 文件就是个可执行的二进制，电脑按照这之中的代码来决定如何引导操作系统</p><p>GPT分区表，并不是必须的</p><p>传统引导扇区，就那么点容量，现在的 efi 文件，一两 mb 都是可以的</p><hr><p>多系统共存，难点其实在于规划，只要让多条引导拉起不同的系统，也就实现了共存。<br>规划要让多个系统的文件分离开，确切说是互相不要产生不可控的影响</p><p>当然，最乱的时候，我的电脑里同时躺着4个系统</p><blockquote><p>win7, xp, ubuntu, mac</p></blockquote><p>ubuntu是干啥的？导出声卡 codec 和 dsdt，以前玩黑果的人都知道</p><hr><p>传统引导的多系统共存，只需要多个主分区即可，当然因为MBR的限制，最多只有四个分区(所有逻辑分区算一个，但逻辑分区无法引导)<br>也就是，单硬盘四个可设置活动分区的主分区，就是极限。当然，正常人谁会用到那么多</p></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/11/id_2184768189/"><img class="fill" src="/gallery/%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85(%E4%B8%80)-1.png" alt="裸机运维(一)-远程服务器安装"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-11-24T07:18:02.000Z" title="2020-11-24T07:18:02.000Z">2020-11-24</time>发表</span><span class="level-item"><time datetime="2020-11-24T07:18:02.000Z" title="2020-11-24T07:18:02.000Z">2020-11-24</time>更新</span><span class="level-item">12 分钟读完 (大约1830个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/11/id_2184768189/">裸机运维(一)-远程服务器安装</a></h1><div class="content"><h2 id="intro"><a href="#intro" class="headerlink" title="intro"></a>intro</h2><p>裸机运维系列1</p><p>文中提到的工具，在文末有<a href="##Other">下载地址</a></p><p>最近因为点特别情况，需要远程搞几台服务器</p><p>服务器有超微板子的工控机，有 dell r610 和同年代的 r410，反正都挺慢的</p><p>用 IPMI 远程安装系统，也算是裸机运维的第二步。你问第一步是啥？当然是给 IPMI 配地址了啊</p><p><img src="/2020/11/id_2184768189/1.png" alt="超微IPMI的配置，用IPMI连过来不让修改"></p><h2 id="pre"><a href="#pre" class="headerlink" title="pre"></a>pre</h2><h3 id="first"><a href="#first" class="headerlink" title="first"></a>first</h3><p>机器不在本地，远程那边有一个 windows 10 来做工作环境，所以下文本地指代的都是这台 windows 10。</p><p>安装系统的过程，和自己插 U盘 安装完全一致，也就没什么多说的了</p><p>因为网段内，没有啥基础设施，机器也不多，所以 IPMI 手动改<code>静态ip</code>，省心</p><p>dell 可以直接在面板上按，超微工控就得进 bios 了，好在超微板子开机快，并不是太费劲。</p><p>(dell)的机器忘了拍照，感兴趣的自己去玩吧</p><p>dell 的 idrac，一个字，慢，哪方面都是</p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>首先，IPMI，需要 java。</p><p>嗯……我这都是老机器，没有 web console 那种先进玩意</p><p>所以，先装一套 java。</p><p>尤其注意，oracle jdk 8。别装错了</p><p>javaws 在这里比较方便用，其他版本，虽然有不少也可以的，不过9之后的版本，安全设置位置不同，得自己找资料</p><p>如果你的机器不是那么野性，可以直接用 OpenWebStart ，可惜 r610 的 idrac 不改 Java 安全文件就起不来，我还是单独装了一套 jdk</p><h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><h3 id="粗野的手法"><a href="#粗野的手法" class="headerlink" title="粗野的手法"></a>粗野的手法</h3><p>直接在 ipmi kvm 中挂载 iso 即可，就像是自己插了个u盘上去</p><p>当然，这个方法，有个很傻逼的点，就是速度实在是，太慢啦！</p><p>传输速度仅有 1m。一个 600m 的镜像，要 10 分钟才能启动。</p><h3 id="ipxe-更加高端快速的手段"><a href="#ipxe-更加高端快速的手段" class="headerlink" title="ipxe 更加高端快速的手段"></a>ipxe 更加高端快速的手段</h3><p>本片文章主要记录的就是这部分</p><p>这里不是科普，不是技术探究，也不是什么尖端问题分析。只是记录自己的解法，当作备忘。</p><p>IPMI 直传，慢的原因在于 IPMI。就别想着什么优化了，我这俩机器拿线直接插上，也还是1m，可能这几个机器的 IPMI 就这么设计的吧</p><p>破局的方法是 PXE 网络引导，通过本地搭建 PXE 服务器做引导。解决 IPMI 速度过慢问题。</p><p>我没有测试原生 PXE 咋样，我嫌麻烦，用了比较成品的方案。</p><p>ipxe 可选使用 http 传输，速度嘛，打满了百兆(这几台机器 IPMI 都是百兆网卡)</p><p>我懒得去找台 linux 搭建 ipxe，所以偷懒用了 tiny pxe server。</p><p><img src="/2020/11/id_2184768189/QQ%E6%88%AA%E5%9B%BE20201124171641.png" alt="tiny pxe server界面"></p><p>界面十分简单。有需要详细教程的自行百度。因为我的网卡 pxe 都是跑在 legacy 引导下，所以没法上 uefi</p><p>我的应用场景很简单，拿 PXE 替代引导U盘 就行，把镜像放到指定位置，选好网卡，点击启动就行了。</p><p>程序自带 httpd:80，DHCP 所以当心当前 vlan 内有其他新设备上线，会被分配到 IP 的。</p><p>默认配置文件在 menu.ipex，需要自行改动，语法很简单，找使用了 sanboot 的项目，复制一份改一改就能引导</p><p><img src="/2020/11/id_2184768189/QQ%E6%88%AA%E5%9B%BE20201124172034.png" alt="menu.ipxe"></p><p>顺带一提，网吧的无盘系统，就是用 pxe 启动 iscsi</p><h2 id="更自动化的竞品-netboot-xyz"><a href="#更自动化的竞品-netboot-xyz" class="headerlink" title="更自动化的竞品 netboot.xyz"></a>更自动化的竞品 netboot.xyz</h2><p>只是简单跑了一下，如果我要部署的是 ubuntu，或者 centos，我或许会用这个</p><p>当然，网速够快的话</p><h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><h3 id="dell-r610-Connection-Failed"><a href="#dell-r610-Connection-Failed" class="headerlink" title="dell r610 Connection Failed"></a>dell r610 Connection Failed</h3><p>这个问题发生于 idrac 6, java 8+</p><p>官方有过相应报告，有说法是换成 java 1.7 就好，不过我并没有现成的环境</p><p>原因似乎是 idrac6 默认使用的 tls 算法被标记为禁用，所以最后有两种解法</p><ol><li><p>修改 jre 的文件，解除禁用</p><p>需要修改配置文件</p><p>本方法基于 oracle jdk 8，似乎哪个小版本都成</p><p>修改文件 <code>&#123;JRE_HOME&#125;\lib\security\java.security</code></p><p>直接将 jdk.tls.disabledAlgorithms 注释掉</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Algorithm restrictions for Secure Socket Layer/Transport Layer Security</span></span><br><span class="line"><span class="comment"># (SSL/TLS) processing</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In some environments, certain algorithms or key lengths may be undesirable</span></span><br><span class="line"><span class="comment"># when using SSL/TLS.  This section describes the mechanism for disabling</span></span><br><span class="line"><span class="comment"># algorithms during SSL/TLS security parameters negotiation, including</span></span><br><span class="line"><span class="comment"># protocol version negotiation, cipher suites selection, peer authentication</span></span><br><span class="line"><span class="comment"># and key exchange mechanisms.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Disabled algorithms will not be negotiated for SSL/TLS connections, even</span></span><br><span class="line"><span class="comment"># if they are enabled explicitly in an application.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For PKI-based peer authentication and key exchange mechanisms, this list</span></span><br><span class="line"><span class="comment"># of disabled algorithms will also be checked during certification path</span></span><br><span class="line"><span class="comment"># building and validation, including algorithms used in certificates, as</span></span><br><span class="line"><span class="comment"># well as revocation information such as CRLs and signed OCSP Responses.</span></span><br><span class="line"><span class="comment"># This is in addition to the jdk.certpath.disabledAlgorithms property above.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See the specification of &quot;jdk.certpath.disabledAlgorithms&quot; for the</span></span><br><span class="line"><span class="comment"># syntax of the disabled algorithm string.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> The algorithm restrictions do not apply to trust anchors or</span></span><br><span class="line"><span class="comment"># self-signed certificates.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> This property is currently used by the JDK Reference implementation.</span></span><br><span class="line"><span class="comment"># It is not guaranteed to be examined and used by other implementations.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example:</span></span><br><span class="line"><span class="comment">#   jdk.tls.disabledAlgorithms=MD5, SSLv3, DSA, RSA keySize &lt; 2048</span></span><br><span class="line"><span class="comment">#jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, DH keySize &lt; 1024, \</span></span><br><span class="line"><span class="comment">#    EC keySize &lt; 224, 3DES_EDE_CBC, anon, NULL, \</span></span><br><span class="line"><span class="comment">#    include jdk.disabled.namedCurves</span></span><br></pre></td></tr></table></figure><p>这个配置是禁止 tls 使用某种算法，注释掉是全部放行，有一定风险，不过 java 8 在我这并不是主用</p><p>也有一个说法，移除掉 SSLv3 和 RC4 就行，让两边使用这些算法</p></li><li><p>直接给 idrac 签个证书</p><p>这个方法是 dell community 中提供的方法，我没有尝试</p></li></ol><h3 id="一些傻逼的情况"><a href="#一些傻逼的情况" class="headerlink" title="一些傻逼的情况"></a>一些傻逼的情况</h3><ul><li><p>dell r610 的 idrac 中，下载 jnlp 文件，后缀名会错，需要手动改……</p></li><li><p>dell r610 的 jnlp 默认文件名极长，用 OpenWebStart 打开会报错。手动删掉一大段就好了。</p></li><li><p>超微的ipmi，kvm中 默认 F2 是退出。esxi 界面上，F2 是设置……<br>就很尴尬，需要在 Options 中改键</p></li><li><p>超微的ipmi，kvm中 esc 也有很恶心的情况，记得改配置的时候，看好了提示框是啥<br>我不小心重启了两次……好在重启很快</p></li><li><p>超微提供了 IPMIView20，好歹能用，但是吧，都 2020 年了，就不能适配一下高DPI吗，我这高分屏看着好难受啊(虽然这锅可能要丢给Java)</p><ul><li>这个 IPMIView 中，不晓得是不是带的 jdk 版本有毛病，kvm 中没法挂载 iso，最后还是得靠 OpenWebStart</li></ul></li><li><p>OpenWebStart，自带了下载 jdk 的功能，可下载的版本实在太新，面对旧设备(dell r610)，居然没法握手。还得手动改 jdk，再靠修改 jdk 中允许使用的安全算法，避让这个东西。傻逼老 dell</p></li><li><p>剩下的不太想得起来，再说了</p></li></ul><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>文中的工具下载地址</p><ul><li><a target="_blank" rel="noopener" href="https://openwebstart.com/download/">OpenWebStart</a></li><li><a target="_blank" rel="noopener" href="https://www.supermicro.org.cn/SwDownload/SwSelect_Free.aspx?cat=IPMI">IPMIView</a></li><li>pxesrv<ul><li><a target="_blank" rel="noopener" href="http://labalec.fr/erwan/?page_id=958">pxesrv作者博客</a></li><li><a target="_blank" rel="noopener" href="http://erwan.labalec.fr/tinypxeserver/pxesrv.zip">官方下载地址(很慢)</a></li><li><a target="_blank" rel="noopener" href="https://download.zzmark.top/ipmi/pxesrv.zip">我的镜像(08/01/2020)</a></li></ul></li></ul></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/11/id_983467528/"><img class="fill" src="/gallery/gitlab%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95-1.png" alt="gitlab升级记录"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-11-06T04:01:02.000Z" title="2020-11-06T04:01:02.000Z">2020-11-06</time>发表</span><span class="level-item"><time datetime="2020-11-23T10:16:00.000Z" title="2020-11-23T10:16:00.000Z">2020-11-23</time>更新</span><span class="level-item">10 分钟读完 (大约1507个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/11/id_983467528/">gitlab升级记录</a></h1><div class="content"><p>公司用的版本是 8.17.4 ，研发部门用不惯，恰好内网服务器重新部署，决定升级</p><p>本文中，所有版本号均为编写时的版本参考，必要的地方贴了地址，记得去看新的文档</p><p>本文撰写时，最新版本为 13.5.1，封面截图时最新版本已经是13.6.0，由于没有升级计划，所以并没有使用最新的图</p><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p>首先，备份，并把备份文件拖回本地</p><ul><li><p>备份本体</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure><p>默认情况下，备份结果会在 /var/opt/gitlab/backups</p></li><li><p>将配置文件进行备份</p><ul><li>/etc/gitlab/gitlab.rb 配置文件</li><li>/var/opt/gitlab/nginx/conf nginx配置文件</li><li>/etc/postfix/main.cfpostfix 邮件配置备份(可选)</li><li>/etc/gitlab/gitlab-secrets.json 密钥文件，里面有数据库的密码</li></ul></li></ul><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><p>gitlab 要按照版本逐个升级，官方给出了<a target="_blank" rel="noopener" href="https://docs.gitlab.com/13.5/ee/policy/maintenance.html#example-upgrade-paths">升级路线</a>，</p><p>大概意思就是，跨版本升级，要升级到当前主要版本最新的版本，才能跨入下一个版本</p><p>我们的版本是 8.17.4，最终的升级路线为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8.17.4 -&gt; 8.17.7 -&gt; 9.5.10 -&gt; 10.8.7 -&gt; 11.3.4 -&gt; 11.11.8 -&gt; 12.0.12 -&gt; 12.10.14 -&gt; 13.0.14 -&gt; 13.5.1(当前最新)</span><br></pre></td></tr></table></figure><p>极其漫长……</p><h3 id="pre"><a href="#pre" class="headerlink" title="pre"></a>pre</h3><p>首先一个误区，升级不能关闭 gitlab</p><p>如果以前改动过某些配置文件，中间可能会有询问，所以盯着点</p><p>执行 upgrade 时，系统的部分也会升级，如果用的系统已经不在维护期内，比如ubuntu 1710(我们就是这傻逼东西)，最好先解决系统问题</p><p>我的做法是，拉个新虚拟机，ubuntu 1604 lts(截止到2021年4月)，不选1804纯是因为手上只有这现成的，之后会考虑迁移到 centos7.8(EOL 2024年6月)</p><p>记得替换源（我用的是 清华）</p><p>执行命令时，最好给 ssh 工具开个日志记录，我用的 xshell，记录下过程中的日志，避免出了问题不好排查</p><h3 id="各路升级命令"><a href="#各路升级命令" class="headerlink" title="各路升级命令"></a>各路升级命令</h3><p>很复制粘贴，直接升级上来就行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get upgrade gitlab-ce=8.17.7-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=9.5.10-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=10.8.7-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=11.3.4-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=11.11.8-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=12.0.12-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=12.10.14-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=13.0.14-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=13.5.1-ce.0</span><br></pre></td></tr></table></figure><p>感谢多年前部署该系统的人，没有给我留什么配置文件上的大坑</p><h2 id="迁移到docker中"><a href="#迁移到docker中" class="headerlink" title="迁移到docker中"></a>迁移到docker中</h2><p>为了方便日后维护，新开了个靠谱的虚拟机，专门用于 gitlab (以前的gitlab连raid都没有)。</p><p>迁移过程如下</p><p>配置块存储、mount、fstab、docker/daemon.json、net优化，宿主机该做的都做完后，用 docker-compose 启动 gitlab</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gitlab/gitlab-ce:13.5.1-ce.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&#x27;gitlab.vajra.ltd&#x27;</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">256M</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">external_url</span> <span class="string">&#x27;http://gitlab.vajra.ltd&#x27;</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_default_projects_features_builds&#x27;]</span> <span class="string">=</span> <span class="literal">false</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;lfs_enabled&#x27;]</span> <span class="string">=</span> <span class="literal">true</span><span class="string">;</span></span><br><span class="line">        <span class="string">nginx[&#x27;custom_gitlab_server_config&#x27;]</span> <span class="string">=</span> <span class="string">&quot;location /-/plantuml/ &#123; \n    proxy_cache off; \n    proxy_pass  http://plantuml:8080/; \n&#125;\n&quot;</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;ldap_enabled&#x27;]</span> <span class="string">=</span> <span class="literal">true</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;prevent_ldap_sign_in&#x27;]</span> <span class="string">=</span> <span class="literal">false</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;ldap_servers&#x27;]</span> <span class="string">=</span> &#123;</span><br><span class="line">          <span class="string">&#x27;main&#x27;</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">            <span class="string">&#x27;label&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;LDAP&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span> <span class="string">=&gt;</span>  <span class="string">&#x27;ldap.vajra.ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span> <span class="string">=&gt;</span> <span class="number">389</span>,</span><br><span class="line">            <span class="string">&#x27;uid&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;encryption&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;plain&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;bind_dn&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;cn=admin,dc=vajra,dc=ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span> <span class="string">=&gt;</span> <span class="number">10</span>,</span><br><span class="line">            <span class="string">&#x27;active_directory&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;allow_username_or_email_login&#x27;</span> <span class="string">=&gt;</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;block_auto_created_users&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;base&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;ou=Users,dc=vajra,dc=ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;attributes&#x27;</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">              <span class="string">&#x27;username&#x27;</span> <span class="string">=&gt;</span> [<span class="string">&#x27;uid&#x27;</span>, <span class="string">&#x27;userid&#x27;</span>, <span class="string">&#x27;sAMAccountName&#x27;</span>],</span><br><span class="line">              <span class="string">&#x27;email&#x27;</span> <span class="string">=&gt;</span> [<span class="string">&#x27;mail&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;userPrincipalName&#x27;</span>],</span><br><span class="line">              <span class="string">&#x27;name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;cn&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;first_name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;givenName&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;last_name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;sn&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;lowercase_usernames&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;22:22&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">plantuml:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;plantuml/plantuml-server:jetty&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">plantuml</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><p>docker中安装相同版本，然后按照传统步骤执行。</p><ol><li>先确保 gitlab-secrets.json 一致</li><li>将备份文件复制到 docker 容器的映射目录中</li><li>修复权限(因为是直接目录挂载到了容器内，没有用 volume，为的是日后提取东西方便，虽然这样也脆弱了很多)</li></ol><p>参考 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/raketasks/backup_restore.html#restore-for-docker-image-and-gitlab-helm-chart-installations">官方文档-docker恢复步骤</a>，按步骤执行即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker <span class="built_in">exec</span> -it xxxxx bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止相关服务</span></span><br><span class="line">$ gitlab-ctl stop unicorn</span><br><span class="line">$ gitlab-ctl stop puma</span><br><span class="line">$ gitlab-ctl stop sidekiq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查状态</span></span><br><span class="line">$ gitlab-ctl status</span><br><span class="line">run: alertmanager: (pid 1001) 1719s; run: <span class="built_in">log</span>: (pid 695) 1765s</span><br><span class="line">run: gitaly: (pid 1021) 1718s; run: <span class="built_in">log</span>: (pid 301) 1898s</span><br><span class="line">run: gitlab-exporter: (pid 626) 1787s; run: <span class="built_in">log</span>: (pid 640) 1783s</span><br><span class="line">run: gitlab-workhorse: (pid 966) 1720s; run: <span class="built_in">log</span>: (pid 588) 1802s</span><br><span class="line">run: grafana: (pid 1029) 1718s; run: <span class="built_in">log</span>: (pid 745) 1755s</span><br><span class="line">run: logrotate: (pid 609) 1793s; run: <span class="built_in">log</span>: (pid 621) 1789s</span><br><span class="line">run: nginx: (pid 591) 1799s; run: <span class="built_in">log</span>: (pid 602) 1795s</span><br><span class="line">run: postgres-exporter: (pid 1010) 1718s; run: <span class="built_in">log</span>: (pid 719) 1761s</span><br><span class="line">run: postgresql: (pid 392) 1893s; run: <span class="built_in">log</span>: (pid 478) 1891s</span><br><span class="line">run: prometheus: (pid 983) 1719s; run: <span class="built_in">log</span>: (pid 678) 1771s</span><br><span class="line">down: puma: 11s, normally up; run: <span class="built_in">log</span>: (pid 528) 1814s</span><br><span class="line">run: redis: (pid 258) 1905s; run: <span class="built_in">log</span>: (pid 265) 1904s</span><br><span class="line">run: redis-exporter: (pid 976) 1720s; run: <span class="built_in">log</span>: (pid 659) 1777s</span><br><span class="line">down: sidekiq: 4s, normally up; run: <span class="built_in">log</span>: (pid 553) 1808s</span><br><span class="line">run: sshd: (pid 27) 1925s; run: <span class="built_in">log</span>: (pid 26) 1925s</span><br><span class="line"></span><br><span class="line">$ gitlab-backup restore BACKUP=1604455708_2020_11_04_13.5.1</span><br></pre></td></tr></table></figure><p>完成上述动作后，重启容器，等待服务正常运转后，执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check GitLab</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;name of container&gt; gitlab-rake gitlab:check SANITIZE=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>完全通过后，迁移完成，后续升级按照 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/omnibus/docker/README.html#update">docker 升级流程</a>，就是按照版本，直接删掉旧容器，换成新的启动，即可</p><p>gitlab 配置了 LDAP，这部分之后新开文章记录</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>整合后，途中断过一次电，发现 docker 容器整个都丢了……</p><p>虽然不晓得怎么回事，不过好在恢复起来不是太难，重新创建一个容器就好了</p><p>但创建容器后，并没有启动，查询日志发现，容器出现了几个问题</p><h3 id="权限问题-Permission-Denied"><a href="#权限问题-Permission-Denied" class="headerlink" title="权限问题 Permission Denied"></a>权限问题 <code>Permission Denied</code></h3><p>很容易解决</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab update-permissions</span><br></pre></td></tr></table></figure><h3 id="Redis-RDB-无法读取"><a href="#Redis-RDB-无法读取" class="headerlink" title="Redis RDB 无法读取"></a>Redis RDB 无法读取</h3><p>具体日志忘了存留<br>解决方法也很简单，摸到 redis 日志位置，直接删掉，收工，连容器都不用重启</p><h3 id="alertmanager-unexpected-EOF"><a href="#alertmanager-unexpected-EOF" class="headerlink" title="alertmanager unexpected EOF"></a>alertmanager unexpected EOF</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">caller&#x3D;main.go:261 err&#x3D;&quot;unexpected EOF&quot;</span><br></pre></td></tr></table></figure><p>解法同上，摸过去删掉，反正 alertmanager 的存储只有告警历史和 since 配置，这些都可以重来</p><p>gitlab 的容器十分完备，连 <code>ps aux | grep alertmanager</code> 这命令都能执行，追查起来和宿主机一样</p></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li></ul></nav></div><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/af01413b547f9ea694fb1d5b513c63b9?s=128" alt="Mark Zhou"></figure><p class="title is-size-4 is-block" style="line-height:inherit">Mark Zhou</p><p class="is-size-6 is-block">keep simple</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>北京</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">25</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ZzMark" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ZzMark"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zz_Mark06"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">八月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">七月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">四月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Blog/"><span class="tag">Blog</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTML/"><span class="tag">HTML</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Iot/"><span class="tag">Iot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nuxt-js/"><span class="tag">Nuxt.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SEO/"><span class="tag">SEO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSR/"><span class="tag">SSR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue-js/"><span class="tag">Vue.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/caddy/"><span class="tag">caddy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/https/"><span class="tag">https</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ide/"><span class="tag">ide</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/meta/"><span class="tag">meta</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tomcat/"><span class="tag">tomcat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tools/"><span class="tag">tools</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%8E%AF%E5%A2%83/"><span class="tag">环境</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E7%BB%B4/"><span class="tag">运维</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5036449195935522" data-ad-slot="5036449195935522" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mark Zhou</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent" target="_blank" rel="noopener" title="黑ICP备17001410号" href="https://beian.miit.gov.cn/">黑ICP备17001410号</a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load",()=>{window.cookieconsent.initialise({type:"info",theme:"edgeless",static:!1,position:"bottom-right",content:{message:"此网站使用Cookie来改善您的体验。",dismiss:"知道了！",allow:"允许使用Cookie",deny:"拒绝",link:"了解更多",policy:"Cookie政策",href:"https://www.cookiesandyou.com/"},palette:{popup:{background:"#edeff5",text:"#838391"},button:{background:"#4b81e8"}}})})</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})}))</script></body></html>