<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>调律者</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="调律者"><meta name="msapplication-TileImage" content="/static/img/avatar.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="调律者"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="160x160" href="/static/img/avatar.jpg"><meta property="og:type" content="blog"><meta property="og:title" content="调律者"><meta property="og:url" content="http://www.zzmark.top/"><meta property="og:site_name" content="调律者"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.zzmark.top/img/og_image.png"><meta property="article:author" content="Mark Zhou"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><meta property="twitter:creator" content="@Zz_Mark06"><meta property="twitter:site" content="https://twitter.com/Zz_Mark06"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.zzmark.top"},"headline":"调律者","image":["http://www.zzmark.top/img/og_image.png"],"author":{"@type":"Person","name":"Mark Zhou"},"publisher":{"@type":"Organization","name":"调律者","logo":{"@type":"ImageObject","url":"http://www.zzmark.top/static/img/avatar.jpg"}},"description":""}</script><link rel="icon" href="/static/img/avatar.jpg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.4.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?c3e99bfff793bb7f4d6646bc513afec5";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-154883003-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154883003-1")</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-5036449195935522" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="调律者" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/kms">KMS服务</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/11/id_983467528/"><img class="fill" src="/gallery/gitlab%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95-1.png" alt="gitlab升级记录"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-11-06T04:01:02.000Z" title="2020-11-6 12:01:02 ├F10: PM┤">2020-11-06</time>发表</span><span class="level-item"><time datetime="2020-11-23T10:16:00.000Z" title="2020-11-23 6:16:00 ├F10: PM┤">2020-11-23</time>更新</span><span class="level-item">10 分钟读完 (大约1507个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/11/id_983467528/">gitlab升级记录</a></h1><div class="content"><p>公司用的版本是 8.17.4 ，研发部门用不惯，恰好内网服务器重新部署，决定升级</p><p>本文中，所有版本号均为编写时的版本参考，必要的地方贴了地址，记得去看新的文档</p><p>本文撰写时，最新版本为 13.5.1，封面截图时最新版本已经是13.6.0，由于没有升级计划，所以并没有使用最新的图</p><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p>首先，备份，并把备份文件拖回本地</p><ul><li><p>备份本体</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure><p>默认情况下，备份结果会在 /var/opt/gitlab/backups</p></li><li><p>将配置文件进行备份</p><ul><li>/etc/gitlab/gitlab.rb 配置文件</li><li>/var/opt/gitlab/nginx/conf nginx配置文件</li><li>/etc/postfix/main.cfpostfix 邮件配置备份(可选)</li><li>/etc/gitlab/gitlab-secrets.json 密钥文件，里面有数据库的密码</li></ul></li></ul><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><p>gitlab 要按照版本逐个升级，官方给出了<a target="_blank" rel="noopener" href="https://docs.gitlab.com/13.5/ee/policy/maintenance.html#example-upgrade-paths">升级路线</a>，</p><p>大概意思就是，跨版本升级，要升级到当前主要版本最新的版本，才能跨入下一个版本</p><p>我们的版本是 8.17.4，最终的升级路线为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8.17.4 -&gt; 8.17.7 -&gt; 9.5.10 -&gt; 10.8.7 -&gt; 11.3.4 -&gt; 11.11.8 -&gt; 12.0.12 -&gt; 12.10.14 -&gt; 13.0.14 -&gt; 13.5.1(当前最新)</span><br></pre></td></tr></table></figure><p>极其漫长……</p><h3 id="pre"><a href="#pre" class="headerlink" title="pre"></a>pre</h3><p>首先一个误区，升级不能关闭 gitlab</p><p>如果以前改动过某些配置文件，中间可能会有询问，所以盯着点</p><p>执行 upgrade 时，系统的部分也会升级，如果用的系统已经不在维护期内，比如ubuntu 1710(我们就是这傻逼东西)，最好先解决系统问题</p><p>我的做法是，拉个新虚拟机，ubuntu 1604 lts(截止到2021年4月)，不选1804纯是因为手上只有这现成的，之后会考虑迁移到 centos7.8(EOL 2024年6月)</p><p>记得替换源（我用的是 清华）</p><p>执行命令时，最好给 ssh 工具开个日志记录，我用的 xshell，记录下过程中的日志，避免出了问题不好排查</p><h3 id="各路升级命令"><a href="#各路升级命令" class="headerlink" title="各路升级命令"></a>各路升级命令</h3><p>很复制粘贴，直接升级上来就行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get upgrade gitlab-ce=8.17.7-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=9.5.10-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=10.8.7-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=11.3.4-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=11.11.8-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=12.0.12-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=12.10.14-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=13.0.14-ce.0</span><br><span class="line">sudo apt-get upgrade gitlab-ce=13.5.1-ce.0</span><br></pre></td></tr></table></figure><p>感谢多年前部署该系统的人，没有给我留什么配置文件上的大坑</p><h2 id="迁移到docker中"><a href="#迁移到docker中" class="headerlink" title="迁移到docker中"></a>迁移到docker中</h2><p>为了方便日后维护，新开了个靠谱的虚拟机，专门用于 gitlab (以前的gitlab连raid都没有)。</p><p>迁移过程如下</p><p>配置块存储、mount、fstab、docker/daemon.json、net优化，宿主机该做的都做完后，用 docker-compose 启动 gitlab</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gitlab/gitlab-ce:13.5.1-ce.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&#x27;gitlab.vajra.ltd&#x27;</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">256M</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">external_url</span> <span class="string">&#x27;http://gitlab.vajra.ltd&#x27;</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_default_projects_features_builds&#x27;]</span> <span class="string">=</span> <span class="literal">false</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;lfs_enabled&#x27;]</span> <span class="string">=</span> <span class="literal">true</span><span class="string">;</span></span><br><span class="line">        <span class="string">nginx[&#x27;custom_gitlab_server_config&#x27;]</span> <span class="string">=</span> <span class="string">&quot;location /-/plantuml/ &#123; \n    proxy_cache off; \n    proxy_pass  http://plantuml:8080/; \n&#125;\n&quot;</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;ldap_enabled&#x27;]</span> <span class="string">=</span> <span class="literal">true</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;prevent_ldap_sign_in&#x27;]</span> <span class="string">=</span> <span class="literal">false</span><span class="string">;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;ldap_servers&#x27;]</span> <span class="string">=</span> &#123;</span><br><span class="line">          <span class="string">&#x27;main&#x27;</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">            <span class="string">&#x27;label&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;LDAP&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span> <span class="string">=&gt;</span>  <span class="string">&#x27;ldap.vajra.ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span> <span class="string">=&gt;</span> <span class="number">389</span>,</span><br><span class="line">            <span class="string">&#x27;uid&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;encryption&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;plain&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;bind_dn&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;cn=admin,dc=vajra,dc=ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span> <span class="string">=&gt;</span> <span class="number">10</span>,</span><br><span class="line">            <span class="string">&#x27;active_directory&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;allow_username_or_email_login&#x27;</span> <span class="string">=&gt;</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;block_auto_created_users&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;base&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;ou=Users,dc=vajra,dc=ltd&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;attributes&#x27;</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">              <span class="string">&#x27;username&#x27;</span> <span class="string">=&gt;</span> [<span class="string">&#x27;uid&#x27;</span>, <span class="string">&#x27;userid&#x27;</span>, <span class="string">&#x27;sAMAccountName&#x27;</span>],</span><br><span class="line">              <span class="string">&#x27;email&#x27;</span> <span class="string">=&gt;</span> [<span class="string">&#x27;mail&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;userPrincipalName&#x27;</span>],</span><br><span class="line">              <span class="string">&#x27;name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;cn&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;first_name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;givenName&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;last_name&#x27;</span> <span class="string">=&gt;</span> <span class="string">&#x27;sn&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;lowercase_usernames&#x27;</span> <span class="string">=&gt;</span> <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;22:22&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">plantuml:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;plantuml/plantuml-server:jetty&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">plantuml</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><p>docker中安装相同版本，然后按照传统步骤执行。</p><ol><li>先确保 gitlab-secrets.json 一致</li><li>将备份文件复制到 docker 容器的映射目录中</li><li>修复权限(因为是直接目录挂载到了容器内，没有用 volume，为的是日后提取东西方便，虽然这样也脆弱了很多)</li></ol><p>参考 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/raketasks/backup_restore.html#restore-for-docker-image-and-gitlab-helm-chart-installations">官方文档-docker恢复步骤</a>，按步骤执行即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker <span class="built_in">exec</span> -it xxxxx bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止相关服务</span></span><br><span class="line">$ gitlab-ctl stop unicorn</span><br><span class="line">$ gitlab-ctl stop puma</span><br><span class="line">$ gitlab-ctl stop sidekiq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查状态</span></span><br><span class="line">$ gitlab-ctl status</span><br><span class="line">run: alertmanager: (pid 1001) 1719s; run: <span class="built_in">log</span>: (pid 695) 1765s</span><br><span class="line">run: gitaly: (pid 1021) 1718s; run: <span class="built_in">log</span>: (pid 301) 1898s</span><br><span class="line">run: gitlab-exporter: (pid 626) 1787s; run: <span class="built_in">log</span>: (pid 640) 1783s</span><br><span class="line">run: gitlab-workhorse: (pid 966) 1720s; run: <span class="built_in">log</span>: (pid 588) 1802s</span><br><span class="line">run: grafana: (pid 1029) 1718s; run: <span class="built_in">log</span>: (pid 745) 1755s</span><br><span class="line">run: logrotate: (pid 609) 1793s; run: <span class="built_in">log</span>: (pid 621) 1789s</span><br><span class="line">run: nginx: (pid 591) 1799s; run: <span class="built_in">log</span>: (pid 602) 1795s</span><br><span class="line">run: postgres-exporter: (pid 1010) 1718s; run: <span class="built_in">log</span>: (pid 719) 1761s</span><br><span class="line">run: postgresql: (pid 392) 1893s; run: <span class="built_in">log</span>: (pid 478) 1891s</span><br><span class="line">run: prometheus: (pid 983) 1719s; run: <span class="built_in">log</span>: (pid 678) 1771s</span><br><span class="line">down: puma: 11s, normally up; run: <span class="built_in">log</span>: (pid 528) 1814s</span><br><span class="line">run: redis: (pid 258) 1905s; run: <span class="built_in">log</span>: (pid 265) 1904s</span><br><span class="line">run: redis-exporter: (pid 976) 1720s; run: <span class="built_in">log</span>: (pid 659) 1777s</span><br><span class="line">down: sidekiq: 4s, normally up; run: <span class="built_in">log</span>: (pid 553) 1808s</span><br><span class="line">run: sshd: (pid 27) 1925s; run: <span class="built_in">log</span>: (pid 26) 1925s</span><br><span class="line"></span><br><span class="line">$ gitlab-backup restore BACKUP=1604455708_2020_11_04_13.5.1</span><br></pre></td></tr></table></figure><p>完成上述动作后，重启容器，等待服务正常运转后，执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check GitLab</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;name of container&gt; gitlab-rake gitlab:check SANITIZE=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>完全通过后，迁移完成，后续升级按照 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/omnibus/docker/README.html#update">docker 升级流程</a>，就是按照版本，直接删掉旧容器，换成新的启动，即可</p><p>gitlab 配置了 LDAP，这部分之后新开文章记录</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>整合后，途中断过一次电，发现 docker 容器整个都丢了……</p><p>虽然不晓得怎么回事，不过好在恢复起来不是太难，重新创建一个容器就好了</p><p>但创建容器后，并没有启动，查询日志发现，容器出现了几个问题</p><h3 id="权限问题-Permission-Denied"><a href="#权限问题-Permission-Denied" class="headerlink" title="权限问题 Permission Denied"></a>权限问题 <code>Permission Denied</code></h3><p>很容易解决</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab update-permissions</span><br></pre></td></tr></table></figure><h3 id="Redis-RDB-无法读取"><a href="#Redis-RDB-无法读取" class="headerlink" title="Redis RDB 无法读取"></a>Redis RDB 无法读取</h3><p>具体日志忘了存留<br>解决方法也很简单，摸到 redis 日志位置，直接删掉，收工，连容器都不用重启</p><h3 id="alertmanager-unexpected-EOF"><a href="#alertmanager-unexpected-EOF" class="headerlink" title="alertmanager unexpected EOF"></a>alertmanager unexpected EOF</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">caller&#x3D;main.go:261 err&#x3D;&quot;unexpected EOF&quot;</span><br></pre></td></tr></table></figure><p>解法同上，摸过去删掉，反正 alertmanager 的存储只有告警历史和 since 配置，这些都可以重来</p><p>gitlab 的容器十分完备，连 <code>ps aux | grep alertmanager</code> 这命令都能执行，追查起来和宿主机一样</p></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/09/id_2756259807/"><img class="fill" src="/gallery/Accept-Language%E7%9B%B8%E5%85%B3%E7%A0%94%E7%A9%B6.png" alt="i18n-Accept-Language相关研究"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-09-22T16:00:00.000Z" title="2020-9-23 12:00:00 ├F10: AM┤">2020-09-23</time>发表</span><span class="level-item"><time datetime="2020-09-22T16:00:00.000Z" title="2020-9-23 12:00:00 ├F10: AM┤">2020-09-23</time>更新</span><span class="level-item">7 分钟读完 (大约1016个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/09/id_2756259807/">i18n-Accept-Language相关研究</a></h1><div class="content"><p>网页端 i18n 必然会涉及到的 header 就是 Accept-Language</p><p>相关内容可以直接参考 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language">MDN Accept-Language</a></p><p>不过这个字段对于中文，有许多历史遗留问题，这里只讲最终结论</p><p>关于 Accept-Language 以及各种操作系统 lang 的取值，遵守的标准是 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/bcp47">ieft-BCP47 Tags for Identifying Languages</a></p><h2 id="zh-zh-CN-zh-Hans-zh-Hant-之间的关系"><a href="#zh-zh-CN-zh-Hans-zh-Hant-之间的关系" class="headerlink" title="zh, zh-CN, zh-Hans, zh-Hant 之间的关系"></a>zh, zh-CN, zh-Hans, zh-Hant 之间的关系</h2><p>如果你的系统语言环境是 <code>简体中文</code>，那么 chrome 浏览器会默认将 Accept-Language 填写为 <code>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-HK;q=0.6</code></p><p><img src="/2020/09/id_2756259807/0.png" alt="Chrome 请求 Header"></p><p>这其中有很多有趣的点可以解读</p><p>首先，<code>zh-CH,zh;q=0.9</code>，这其实是两部分，写完整的话应该是 <code>zh-CH;q=1.0,zh;q=0.9</code> 用q做了一个优先度</p><p>但这俩都是中文，目前大多数的服务端，都会将 zh-CN 当作 <code>简体中文</code>，但实际上并不正确，这就是历史遗留问题<br>第二种 zh 实际上也是废弃标准，但绝大多数服务端，都没有舍弃这两种废弃标准的使用。</p><p>类似的还有很多，如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zh-Hans, zh-Hans-CN, zh-cmn, zh-cmn-Hans, zh-wuu, zh-yue, zh-gan</span><br><span class="line">zh-Hans-HK、zh-Hans-MO、zh-Hans-TW、zh-Hant</span><br></pre></td></tr></table></figure><p>严格上来说，语言的标记格式为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">language    -extlang         -script  -region    -variant -extension -privateuse</span><br><span class="line">语言文字种类 -扩展语言文字种类 -书写格式 -国家和地区 -变体     -扩展      -私有</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zh 中文，因为无法指代语言，所以废弃。但大部分服务端将此认定为 zh-Hans</span><br><span class="line">zh-Hans 汉语-简体(han 汉语, s Simplified_Chinese)</span><br><span class="line">zh-Hant 汉语-繁体(t Traditional_Chinese)</span><br></pre></td></tr></table></figure><p>实际上还有一些极为不常用的中文语种</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zh-cmm</span><br></pre></td></tr></table></figure><p>还有同样不常用，而且不符合标准，但还是有用到的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zh-SG</span><br><span class="line">zh-TW</span><br><span class="line">zh-HK</span><br></pre></td></tr></table></figure><p>还有些符合标准，但并不在 Accept-Language 中受到支持的完整写法(我是不知道啥服务器认这个)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zh-cmn-Hans 国语-简体中文</span><br><span class="line">zh-cmn-Hant 国语-繁体中文</span><br><span class="line">zh-yue-Hant 粤语-繁体中文</span><br><span class="line">zh-wuu-Hans 上海话-简体中文</span><br></pre></td></tr></table></figure><p>其中 cmn 是国语，yue 是粤语，wuu 是上海话</p><h2 id="后端如何做适配"><a href="#后端如何做适配" class="headerlink" title="后端如何做适配"></a>后端如何做适配</h2><p>长远打算，最好兼容 BCP47，不过现阶段有很多历史遗留用法反而是主流</p><p>目前来说，做好这些兼容就是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zh, zh-CN, zh-Hans, zh-cmn-Hans, Hans   都解析成中文</span><br></pre></td></tr></table></figure><p>不过这是一己之见，没有什么依据</p><p>短期来看，支持个 zh, zh-CN, zh-Hans 其实就够了</p><p><img src="/2020/09/id_2756259807/1.png" alt="ios语言列表"></p><h3 id="springboot"><a href="#springboot" class="headerlink" title="springboot"></a>springboot</h3><p>我们的后端使用这个，所以特意说一手</p><p>默认情况下，springboot 会将 <code>Accept-Language: zh-CN</code> 解析成 <code>Accept-Language: zh-Hans</code></p><p>匹配 message_zh_Hans.properties</p><p>若不存在，降级到 zh_CN</p><p>观测结果</p><p>简单追查，可以得出 zh-Hans 继承于 zh-CN</p><p>不过这个机制，并不是 springboot 或者 spring 的机制，是jre机制</p><p>java.util.ResourceBundle.Control#getCandidateLocales 方法的注释中，有写明对于 Chinese 的特殊处理<br>在线版本可以参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/ResourceBundle.Control.html">https://docs.oracle.com/javase/8/docs/api/java/util/ResourceBundle.Control.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Special cases for Chinese. When an input Locale has the language &quot;zh&quot; (Chinese)</span><br><span class="line">and an empty script value, either &quot;Hans&quot; (Simplified) or &quot;Hant&quot; (Traditional)</span><br><span class="line">might be supplied, depending on the country. When the country is &quot;CN&quot; (China)</span><br><span class="line">or &quot;SG&quot; (Singapore), &quot;Hans&quot; is supplied. When the country is &quot;HK&quot; (Hong Kong</span><br><span class="line">SAR China), &quot;MO&quot; (Macau SAR China), or &quot;TW&quot; (Taiwan), &quot;Hant&quot; is supplied. </span><br><span class="line">For all other countries or when the country is empty, no script is supplied.</span><br><span class="line">For example, for Locale(&quot;zh&quot;, &quot;CN&quot;) , the candidate list will be:</span><br><span class="line">    [L(&quot;zh&quot;), S(&quot;Hans&quot;), C(&quot;CN&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;), S(&quot;Hans&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;), C(&quot;CN&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;)]</span><br><span class="line">    Locale.ROOT</span><br><span class="line">For Locale(&quot;zh&quot;, &quot;TW&quot;), the candidate list will be:</span><br><span class="line">    [L(&quot;zh&quot;), S(&quot;Hant&quot;), C(&quot;TW&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;), S(&quot;Hant&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;), C(&quot;TW&quot;)]</span><br><span class="line">    [L(&quot;zh&quot;)]</span><br><span class="line">    Locale.ROOT</span><br></pre></td></tr></table></figure><h2 id="过于前沿，还没啥用的知识"><a href="#过于前沿，还没啥用的知识" class="headerlink" title="过于前沿，还没啥用的知识"></a>过于前沿，还没啥用的知识</h2><p>BCP47 在 2009年，将 zh 废弃，把 Hans, Hant 提升到了 language 层级<br>也就是说，zh-Hans 应写成 Hans</p><p>不过这个设定，没有程序认……</p></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-07-27T08:20:07.000Z" title="2020-7-27 4:20:07 ├F10: PM┤">2020-07-27</time>发表</span><span class="level-item"><time datetime="2020-07-27T08:20:07.000Z" title="2020-7-27 4:20:07 ├F10: PM┤">2020-07-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></span><span class="level-item">7 分钟读完 (大约1053个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/07/id_1816640273/">电脑上不了网的排查思路</a></h1><div class="content"><p>最近总有连不上网瞎搞然后问我连不上网了怎么办(只说连不上，却不清楚哪里连不上，你就算说一句网页打不开了都行啊)</p><p>所以写下了这个排查思路</p><p>如果稍微懂一点命令行，知道 cmd 怎么打开怎么敲，可以直接去进阶版本，排查更快</p><h2 id="基础版"><a href="#基础版" class="headerlink" title="基础版"></a>基础版</h2><ul><li><p>是否连上了物理网络，就是网线、wifi</p><blockquote><p>这都无法保证，你是怎么舔个脸说自己网不好使的呢</p></blockquote></li><li><p>检查是否有 ip 地址</p><blockquote><p>具体方法，拿手机自行百度，操作系统不同位置不同，懒得讲</p></blockquote></li><li><p>如果是 wifi，用手机连上同一个网络试试，记得把手机流量开关给关上，不然会开着 wifi 却从流量上网，影响判断</p><blockquote><p>如果手机不能用，那么问题就在于这个网本来就不能用，自己家的话，打电话给宽带公司让他们上门修吧</p></blockquote></li><li><p>打开网页，输入 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a></p></li><li><p>若无法访问，输入 <a target="_blank" rel="noopener" href="http://123.207.151.189/">http://123.207.151.189</a> (这是我的地址)，注意标点，只要看到 <code>404 Site 123.20xxxxxxx</code>就算成功</p><blockquote><p>如果直接访问数字地址成功，但 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 失败，可能是 dns 服务配置有误，那么重启个电脑或者等上几分钟或许自己就会好。没好的话，可能真的是配置不对；如果自己不知道什么时候配置了这东西，怀疑电脑坏了吧</p></blockquote></li><li><p>若无法访问，可能电脑出了问题，请思考是不是用了什么奇怪的软件</p></li></ul><h2 id="进阶版"><a href="#进阶版" class="headerlink" title="进阶版"></a>进阶版</h2><p>注意：该思路需要敲命令行，如果连 cmd 都不知道怎么打开，就参考上面的基础版本吧</p><p>思路如下：</p><ul><li>保证物理连接</li><li>保证有正确的 ip</li><li>电脑到网关是通的</li><li>绕过 dns 环节，可访问纯数字地址</li><li>测试 dns</li></ul><p>就这几个步骤，其中物理连接，自己看网卡状态好了</p><ul><li><p>保证有正确的 ip</p><p>cmd 输入 <code>ipconfig</code>，能看到类似于下文的内容，可能会有很多条，也可能名字和我对不上，地址和我对不上，那都不重要。</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ipconfig</span></span><br><span class="line"></span><br><span class="line">以太网适配器 以太网:</span><br><span class="line"></span><br><span class="line">  连接特定的 DNS 后缀 . . . . . . . :</span><br><span class="line">  本地链接 IPv6 地址. . . . . . . . : fe80::<span class="number">48</span>c1:<span class="number">413</span>e:ee4b:<span class="number">1</span>b35%<span class="number">9</span></span><br><span class="line">  IPv4 地址 . . . . . . . . . . . . : <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">56</span></span><br><span class="line">  子网掩码  . . . . . . . . . . . . : <span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span></span><br><span class="line">  默认网关. . . . . . . . . . . . . : <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>电脑到网关是通的</p><p>上一步结果中，默认网关对应的地址，作为这步的参数</p><p>cmd 输入 <code>ping 192.168.3.1</code>，把 192.168.3.1 更换为自己的默认网关</p><p>正常结果如下：</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">ping</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line">正在 <span class="built_in">Ping</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 具有 <span class="number">32</span> 字节的数据:</span><br><span class="line">来自 <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 的回复: 字节=<span class="number">32</span> 时间&lt;<span class="number">1</span>ms TTL=<span class="number">64</span></span><br><span class="line">来自 <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 的回复: 字节=<span class="number">32</span> 时间=<span class="number">1</span>ms TTL=<span class="number">64</span></span><br><span class="line">来自 <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 的回复: 字节=<span class="number">32</span> 时间&lt;<span class="number">1</span>ms TTL=<span class="number">64</span></span><br><span class="line">来自 <span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 的回复: 字节=<span class="number">32</span> 时间&lt;<span class="number">1</span>ms TTL=<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="number">192</span>.<span class="number">168</span>.<span class="number">3</span>.<span class="number">1</span> 的 <span class="built_in">Ping</span> 统计信息:</span><br><span class="line">    数据包: 已发送 = <span class="number">4</span>，已接收 = <span class="number">4</span>，丢失 = <span class="number">0</span> (<span class="number">0</span>% 丢失)，</span><br><span class="line">往返行程的估计时间(以毫秒为单位):</span><br><span class="line">    最短 = <span class="number">0</span>ms，最长 = <span class="number">1</span>ms，平均 = <span class="number">0</span>ms</span><br></pre></td></tr></table></figure><p>如果长得不像(别问不像到什么程度，都是中文，一眼就能看出有问题来)，那么这一步骤失败，电脑可能出现网卡驱动问题，或者IP地址并不正确</p><p>不过这个不够准确，因为有可能路由器(网关)禁止了 ping 命令，所以无论怎样，都应当进行下一步</p></li><li><p>绕过 dns 环节，可访问纯数字地址</p><p>直接用浏览器打开 123.207.151.189，不报错就算成功</p><p>如果失败，证明网是断的。</p><p>网关能通，网却是断的，问题在上游，该找宽带报修就报修吧</p></li><li><p>测试 dns</p><p>直接访问 <a target="_blank" rel="noopener" href="http://www.baidu.com,如果没通,证明/">www.baidu.com，如果没通，证明</a> dns 出了问题</p><p>可以尝试更换 dns，但别忘了测试后换回来</p><p>更换 dns 方法，自行百度</p><p>建议 223.5.5.5 阿里</p></li><li><p>dns 也没问题的情况</p><p>那么，你到底是怎么得出网不好使的呢</p></li></ul></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/07/id_708295649/"><img class="fill" src="/gallery/2.png" alt="TIME_WAIT 过高排查记录"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-07-27T08:11:45.000Z" title="2020-7-27 4:11:45 ├F10: PM┤">2020-07-27</time>发表</span><span class="level-item"><time datetime="2020-07-27T08:11:45.000Z" title="2020-7-27 4:11:45 ├F10: PM┤">2020-07-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></span><span class="level-item">11 分钟读完 (大约1637个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/07/id_708295649/">TIME_WAIT 过高排查记录</a></h1><div class="content"><p>线上服务器遇到了 TIME_WAIT 很高的情况，虽然服务没什么问题，机器剩余的配置很大(总计占用还不足机器的五分之一)，不过这问题很可能成为隐患，所以排查了一番，记录如下：</p><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>TIME_WAIT 的来源</p><img src="/2020/07/id_708295649/1.png" title="TCP三次握手、四次挥手"><p>TCP 的三次握手、四次挥手，<br>常用的三个状态是：<code>ESTABLISHED</code> 表示正在通信，<code>TIME_WAIT</code> 表示主动关闭，<code>CLOSE_WAIT</code> 表示被动关闭<br>三次握手：<br>第一次，主动端发送<code>SYN</code>给 <code>LISTEN</code> 中的被动端，自己切换至 <code>SYN-SENT</code> 状态；<br>第二次，被动端发送<code>ACK</code>确认收到信号和<code>SYN</code>；<br>第三次，主动端发送<code>ACK</code>确认收到被动端<code>SYN</code>。<br>完成上述动作后，两端进入enblished</p><p>四次挥手中，<br>第一次是主动端断开，发送<code>FIN</code>信号，切换至<code>FIN-WAIT-1</code>状态；<br>第二次是被动端收到<code>FIN</code>信号，切换至<code>CLOSE-WAIT</code>状态，然后发送<code>ACK</code>至主动端，主动端收到后切换至<code>FIN-WAIT-2</code>；<br>第三次是被动端等自己的应用断开连接时，发送<code>FIN</code>信号给主动端，被动端切换至<code>LAST-ACK</code>；<br>第四次是主动端收到被动端的<code>FIN</code>信号，然后发送<code>ACK</code>信号，切换至<code>TIME-WAIT</code>状态，等待内核回收。</p></li></ol><h2 id="百度带来的坑"><a href="#百度带来的坑" class="headerlink" title="百度带来的坑"></a>百度带来的坑</h2><p>随手搜索问题之后，无论是 baidu 还是 google，搜到的大量内容，都是叫你优化 <code>net.ipv4</code> 这种治标不治本的方法，什么加快 TIME_WAIT 回收啊，增大量级啊</p><p>但是，问题的来源并没有解决，以往的经验表明，这么调整或许能解决问题，但连接反复开闭产生的资源消耗依然很大</p><h2 id="定位-TIME-WAIT-原因"><a href="#定位-TIME-WAIT-原因" class="headerlink" title="定位 TIME_WAIT 原因"></a>定位 TIME_WAIT 原因</h2><p>根据 TCP 握手规则，谁有<code>TIME-WAIT</code>，谁就是主动端。这点可以排除用户频繁访问或错误的释放连接的可能。</p><p>意思就是说这都是服务器主动请求断开连接的，而<code>TIME-WAIT</code>状态的链接也没有回收。</p><p>服务端可能产生的请求，也就只有服务间互相调用、访问第三方 API、反向代理</p><p>其实到这里已经快要破案了，要么是程序的 bug，要么是反向代理配置带来的大量 TIME_WAIT</p><p>接下来就是具体定位，连接到底是谁产生的了。</p><h3 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h3><p>目前线上很精简，只有一台机器，使用 docker 作为业务容器，外侧 nginx 做入口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">              (docker)</span><br><span class="line">       |-----------------|</span><br><span class="line">nginx -&gt; traefik -&gt; api</span><br><span class="line">       |-----------------|</span><br></pre></td></tr></table></figure><p>nginx 持有 80 443 端口，traefik 通过 12500 暴露到主机，docker内的服务不对主机暴露端口</p><p>为啥这么设计？</p><p>Let’s encrypt 的证书最近因 akamai 被墙导致 OCSP 无法执行，iOS 端首次请求会等待数秒钟，这对于用户不可接受，而我们又没有购买证书或者更换国内证书的打算(子域名有点多，申请起来太累，还是 acme.sh 来得爽)(还是穷的)</p><p>然而 traefik 并不能处理 <code>OCSP stapling</code>，只好让 nginx 扛起 <code>https</code> 的大任</p><h3 id="命令排查"><a href="#命令排查" class="headerlink" title="命令排查"></a>命令排查</h3><p>(因为执行时的命令结果没有保存，所以这里只有看出情况的命令行了)</p><p>查看 TIME_WAIT 属于哪个连接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tn|grep TIME_WAIT|awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>|sort|uniq -c|sort -nr|head</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m ~]# netstat -tn|grep TIME_WAIT|awk &#39;&#123;print $4&#125;&#39;|sort|uniq -c|sort -nr|head</span><br><span class="line">   2703 127.0.0.1:12500</span><br><span class="line">      2 172.17.3.142:3306</span><br></pre></td></tr></table></figure><p>可以看出，<code>127.0.0.1:12500</code> 持有 2703个 TIME_WAIT，这个端口是后端API服务的监听端口。因为 TIME_WAIT 都是主动方持有，也就是说请求是由本机的程序发往后端 API 的，也就是猜测中的第三种-反向代理的请求</p><p>不过这还没法破案，然后是分析请求来源</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ant|grep 127.0.0.1:12500</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@m ~]# netstat -antp|grep 127.0.0.1:12500</span><br><span class="line">tcp        0      0 127.0.0.1:37860         127.0.0.1:12500         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37828         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37748         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37782         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37728         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37802         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37864         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37720         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37770         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37844         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37810         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37852         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37752         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37742         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37870         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37832         TIME_WAIT  -</span><br><span class="line">tcp6       0      0 127.0.0.1:12500         127.0.0.1:37762         TIME_WAIT  -</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>因为都在本地，这命令下去根本看不出啥来<br>如果是外来请求，或者其他 ip 的请求，那么后方的 127.0.0.1 就会显示那一方的 ip</p><p>如果运气好，能看到 127.0.0.1:12500 在后边，也就是第五个参数位置，那么可以尝试翻一翻是否有最后一个参数，若 TIME_WAIT 占比不是特别绝望，应该能看到几个。<br>而这几个很有可能就是发起者。也算是种猜测了。</p><p>到这里我也没什么排查手段了，因为请求来源是 127.0.0.1，不好确认是哪里来的请求。<br>这也就是单节点带来的痛苦……</p><p>不过按照前面的线索，nginx 的可能性很大</p><h2 id="nginx-带来的-TIME-WAIT"><a href="#nginx-带来的-TIME-WAIT" class="headerlink" title="nginx 带来的 TIME_WAIT"></a>nginx 带来的 TIME_WAIT</h2><ol><li><p>导致 nginx端出现大量TIME_WAIT的情况有两种：</p><p>keepalive_requests设置比较小，高并发下超过此值后nginx会强制关闭和客户端保持的keepalive长连接；（主动关闭连接后导致nginx出现TIME_WAIT）<br>keepalive设置的比较小（空闲数太小），导致高并发下nginx会频繁出现连接数震荡（超过该值会关闭连接），不停的关闭、开启和后端server保持的keepalive长连接；</p></li><li><p>解决方案</p><p>对于反向代理，nginx 提供了一个 upstream 的参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream http_backend &#123;</span><br><span class="line">  server 127.0.0.1:12500;</span><br><span class="line">  keepalive 50;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样便能解决问题。</p><p>下面是该参数的相关逻辑以及官方对此的说明：</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive</a></p></li><li><p>The connections parameter sets the maximum number of idle keepalive connections to upstream servers that are preserved in the cache of each worker process. When this number is exceeded, the least recently used connections are closed.（设置每个 worker 进程保留与上游服务器的 keepalive 连接最大数量。超过此数量时，将关闭最近最少使用的连接。）</p></li><li><p>It should be particularly noted that the keepalive directive does not limit the total number of connections to upstream servers that an nginx worker process can open.（特别提醒：keepalive指令不会限制一个nginx worker到 upstream 连接的总数量）</p></li></ol></div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2020/05/id_661479498/"><img class="fill" src="/gallery/ubuntu.png" alt="记录DHCP-clientid导致IP冲突"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2020-05-06T09:43:44.000Z" title="2020-5-6 5:43:44 ├F10: PM┤">2020-05-06</time>发表</span><span class="level-item"><time datetime="2020-05-17T16:00:00.000Z" title="2020-5-18 12:00:00 ├F10: AM┤">2020-05-18</time>更新</span><span class="level-item">3 分钟读完 (大约510个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/id_661479498/">记录DHCP-clientid导致IP冲突</a></h1><div class="content"><p>本次问题基于 ubuntu 1804, centos用户不要对坐(号)入号(座)</p><p>最近弄了一台物理服务器，复制了几个 ubuntu 1804，但出了一个神奇问题，这几台机器无一例外，dhcp获取的都是同一个ip</p><p>百思不得其解的问题，明明 mac 地址不同，为何会出这种事情</p><p>然后开始了排查历程</p><p>先做几个备忘：</p><ul><li>ubuntu 1804，废弃了 ifupdown，改用 netplan 配置网络，学习成本不高，配置文件在 /etc/netplan/*.yaml，语法比较简单</li><li>可能用到的命令行<ul><li>netplan ip leases <code>&lt;device&gt;</code> 查看网卡信息</li><li>netplan try 执行配置</li></ul></li></ul><p>排查过程中，做了以下尝试：</p><ul><li>尝试了重启网卡</li><li>重启网络服务</li><li>重启机器</li><li>dhclient 重新分配 ip</li></ul><p>无果</p><p>重启网卡时，还遇到了 ifdown 不存在，原来是被废弃了，用 netplan 替代</p><p>但在 netplan ip leases 中，发现了一个参数， CLIENTID，这几台虚机的id是完全一致的</p><p>我的直觉告诉我，问题就在这里</p><p>翻到了靠谱的 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4361">RFC-4361 Node-specific Client Identifiers for Dynamic Host Configuration Protocol Version Four (DHCPv4)</a> 规范</p><p>知其所以然，还是不知道咋解决……</p><p>netplan 提供了这个参数 <a target="_blank" rel="noopener" href="http://manpages.ubuntu.com/manpages/cosmic/man5/netplan.5.html">dhcp-identifier</a></p><p>提供了可以用 mac 当作 dhcp clientid 的配置，尝试一番，可行</p><p>剩下的基础知识，有空再补充</p><hr><p>2020-05-18 更新</p><p>dhcp clientid 的默认值会根据 machine id 变更，克隆出的几台机器完全一致，所以这里才是真正的祸根</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 machine-id</span></span><br><span class="line">cat /etc/machine-id</span><br></pre></td></tr></table></figure><p>可以使用 dbus-uuidgen 来重新生成一个 machine-id</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -f /etc/machine-id</span><br><span class="line">sudo dbus-uuidgen --ensure=/etc/machine-id</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/402999/is-it-ok-to-change-etc-machine-id">https://unix.stackexchange.com/questions/402999/is-it-ok-to-change-etc-machine-id</a></p><p>然后重新使用 netplan apply 获取ip，收工。</p><p>然后，写了个一次性脚本来做这个工作。方式多的很，自行研究了</p></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li></ul></nav></div><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/af01413b547f9ea694fb1d5b513c63b9?s=128" alt="Mark Zhou"></figure><p class="title is-size-4 is-block" style="line-height:inherit">Mark Zhou</p><p class="is-size-6 is-block">keep simple</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>北京</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">32</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">25</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ZzMark" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ZzMark"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Zz_Mark06"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">四月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">三月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">一月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">八月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">七月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">四月 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Blog/"><span class="tag">Blog</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTML/"><span class="tag">HTML</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Iot/"><span class="tag">Iot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nuxt-js/"><span class="tag">Nuxt.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SEO/"><span class="tag">SEO</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSR/"><span class="tag">SSR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue-js/"><span class="tag">Vue.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/caddy/"><span class="tag">caddy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/https/"><span class="tag">https</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ide/"><span class="tag">ide</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/meta/"><span class="tag">meta</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tomcat/"><span class="tag">tomcat</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tools/"><span class="tag">tools</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%8E%AF%E5%A2%83/"><span class="tag">环境</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E7%BB%B4/"><span class="tag">运维</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5036449195935522" data-ad-slot="5036449195935522" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/static/img/avatar.jpg" alt="调律者" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mark Zhou</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent" target="_blank" rel="noopener" title="黑ICP备17001410号" href="https://beian.miit.gov.cn/">黑ICP备17001410号</a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load",()=>{window.cookieconsent.initialise({type:"info",theme:"edgeless",static:!1,position:"bottom-right",content:{message:"此网站使用Cookie来改善您的体验。",dismiss:"知道了！",allow:"允许使用Cookie",deny:"拒绝",link:"了解更多",policy:"Cookie政策",href:"https://www.cookiesandyou.com/"},palette:{popup:{background:"#edeff5",text:"#838391"},button:{background:"#4b81e8"}}})})</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})}))</script></body></html>